<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Èù¢Áõ∏ÂàÜÊûêÂô®</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka+One:wght@400&family=Nunito:wght@400;600;700;800&family=Comic+Neue:wght@400;700&display=swap');

        :root {
            /* Powerpuff Girls theme colors */
            --primary-color: #ff69b4;
            --secondary-color: #ff1493;
            --accent-color: #ffc0cb;
            --blossom-pink: #ff69b4;
            --bubbles-blue: #87ceeb;
            --buttercup-green: #9acd32;
            --background-gradient: linear-gradient(-45deg, #ff69b4, #ff1493, #ffc0cb, #ffb6c1);
            --text-color: #2c3e50;
            
            /* Dynamic color theme variables */
            --dynamic-primary: var(--primary-color);
            --dynamic-secondary: var(--secondary-color);
            --dynamic-accent: var(--accent-color);
            --dynamic-gradient: var(--background-gradient);
            
            /* Theme transition */
            --theme-transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* Dynamic theme classes */
        .theme-warm {
            --dynamic-primary: #ff6b6b;
            --dynamic-secondary: #ffa726;
            --dynamic-accent: #ffcc02;
            --dynamic-gradient: linear-gradient(-45deg, #ff9a9e, #fecfef, #ffa726, #ffcc02);
        }
        
        .theme-cool {
            --dynamic-primary: #4fc3f7;
            --dynamic-secondary: #29b6f6;
            --dynamic-accent: #26c6da;
            --dynamic-gradient: linear-gradient(-45deg, #667eea, #764ba2, #4fc3f7, #26c6da);
        }
        
        .theme-nature {
            --dynamic-primary: #66bb6a;
            --dynamic-secondary: #81c784;
            --dynamic-accent: #a5d6a7;
            --dynamic-gradient: linear-gradient(-45deg, #84fab0, #8fd3f4, #66bb6a, #a5d6a7);
        }
        
        .theme-sunset {
            --dynamic-primary: #ff7043;
            --dynamic-secondary: #ffab40;
            --dynamic-accent: #ffc947;
            --dynamic-gradient: linear-gradient(-45deg, #ff9a9e, #fad0c4, #ff7043, #ffc947);
        }
        
        .theme-ocean {
            --dynamic-primary: #42a5f5;
            --dynamic-secondary: #29b6f6;
            --dynamic-accent: #26c6da;
            --dynamic-gradient: linear-gradient(-45deg, #667eea, #764ba2, #42a5f5, #26c6da);
        }
        
        /* Powerpuff Girls Feature Navigation */
        .powerpuff-feature-nav {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 30px 0;
            padding: 20px;
            background: linear-gradient(135deg, #FFE4E6, #FFF0F5, #E6F3FF);
            border-radius: 30px;
            box-shadow: 0 8px 25px rgba(255, 105, 180, 0.3);
            border: 3px solid var(--blossom-pink);
            position: relative;
            overflow: hidden;
            animation: powerpuffGlow 3s ease-in-out infinite;
        }
        
        .powerpuff-feature-nav::before {
            content: '‚ú®';
            position: absolute;
            top: 10px;
            left: 20px;
            font-size: 20px;
            animation: sparkleRotate 2s linear infinite;
            z-index: 0; /* Ensure sparkles are behind characters */
        }
        
        .powerpuff-feature-nav::after {
            content: 'üí´';
            position: absolute;
            bottom: 10px;
            right: 20px;
            font-size: 18px;
            animation: sparkleRotate 2s linear infinite reverse;
            z-index: 0; /* Ensure sparkles are behind characters */
        }
        
        .feature-character {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px 20px;
            margin: 0 10px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            position: relative;
            background: rgba(255, 255, 255, 0.7);
            border: 2px solid transparent;
            min-width: 100px;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            z-index: 1; /* Ensure characters are above pseudo-elements */
        }
        
        .feature-text {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            color: var(--text-color); /* Ensure default text color for non-active items */
        }
        
        .feature-character:hover {
            transform: translateY(-8px) scale(1.05);
            box-shadow: 0 15px 30px rgba(255, 105, 180, 0.4);
        }
        
        .feature-character.active {
            background: linear-gradient(135deg, var(--blossom-pink), #FF69B4);
            border-color: var(--blossom-pink);
            color: white;
            transform: translateY(-5px) scale(1.1);
            box-shadow: 0 12px 25px rgba(255, 105, 180, 0.5);
        }
        
        .feature-character.blossom {
            border-color: var(--blossom-pink);
        }
        
        .feature-character.blossom.active {
            background: linear-gradient(135deg, var(--blossom-pink), #FF1493);
        }
        
        .feature-character.bubbles {
            border-color: var(--bubbles-blue);
        }
        
        .feature-character.bubbles.active {
            background: linear-gradient(135deg, var(--bubbles-blue), #00BFFF);
        }
        
        .feature-character.buttercup {
            border-color: var(--buttercup-green);
        }
        
        .feature-character.buttercup.active {
            background: linear-gradient(135deg, var(--buttercup-green), #32CD32);
        }
        
        .feature-character.professor {
            border-color: #9370DB;
        }
        
        .feature-character.professor.active {
            background: linear-gradient(135deg, #9370DB, #8A2BE2);
        }
        
        .feature-character.mojo {
            border-color: #FF4500;
        }
        
        .feature-character.mojo.active {
            background: linear-gradient(135deg, #FF4500, #FF6347);
        }
        
        .character-icon {
            font-size: 28px;
            margin-bottom: 8px;
            animation: iconBounce 2s ease-in-out infinite;
        }
        
        .feature-name {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 4px;
            text-align: center;
        }
        
        .character-name {
            font-size: 11px;
            opacity: 0.8;
            font-style: italic;
            text-align: center;
        }
        
        @keyframes powerpuffGlow {
            0%, 100% { box-shadow: 0 8px 25px rgba(255, 105, 180, 0.3); }
            50% { box-shadow: 0 12px 35px rgba(255, 105, 180, 0.5); }
        }
        
        @keyframes sparkleRotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes iconBounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-5px); }
            60% { transform: translateY(-3px); }
        }
        
        @keyframes powerpuffActivate {
            0% { transform: scale(1) rotate(0deg); }
            25% { transform: scale(1.2) rotate(-5deg); }
            50% { transform: scale(1.3) rotate(5deg); }
            75% { transform: scale(1.1) rotate(-2deg); }
            100% { transform: scale(1.1) rotate(0deg); }
        }
        
        @keyframes containerFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        @keyframes heartBeat {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
        
        @keyframes sparkle {
            0%, 100% { opacity: 1; transform: scale(1) rotate(0deg); }
            50% { opacity: 0.7; transform: scale(1.1) rotate(180deg); }
        }
/*
            color: white;
            box-shadow: 0 4px 15px rgba(233, 30, 99, 0.3);
            transform: translateY(-2px);
        }
*/
        
        .tab-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }
        
        .tab-btn:hover::before {
            left: 100%;
        }
        
        /* Matching Analysis Styling */
        .matching-section {
            margin: 20px 0;
            padding: 25px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 8px 25px rgba(233, 30, 99, 0.15);
        }
        
        .matching-intro {
            text-align: center;
            margin-bottom: 25px;
        }
        
        .matching-intro h3 {
            color: var(--dynamic-primary);
            font-size: 1.8em;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .matching-intro p {
            color: #666;
            font-size: 1.1em;
            line-height: 1.5;
        }
        
        .matching-upload-container {
            display: flex;
            align-items: center;
            gap: 20px;
            margin: 25px 0;
        }
        
        .matching-upload-item {
            flex: 1;
            text-align: center;
        }
        
        .matching-upload-item h4 {
            color: var(--dynamic-primary);
            margin-bottom: 15px;
            font-size: 1.2em;
            font-weight: 600;
        }
        
        .matching-upload {
            margin-bottom: 0;
            padding: 20px;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .matching-vs {
            font-size: 2.5em;
            color: var(--dynamic-primary);
            animation: heartbeat 2s ease-in-out infinite;
            text-shadow: 0 0 10px rgba(233, 30, 99, 0.5);
        }
        
        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .matching-preview {
            margin-top: 15px;
            min-height: 150px; /* Increased height for better display */
            border-radius: 10px;
            overflow: hidden; /* Ensure image fits within bounds */
            background: rgba(255, 240, 245, 0.5);
            border: 2px dashed #ffadc5;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .matching-preview img {
            max-width: 100%;
            max-height: 150px; /* Adjusted to match container height */
            border-radius: 8px;
            object-fit: contain; /* Ensure full image is visible without cropping */
        }
        
        .matching-analyze-btn {
            width: 100%;
            padding: 15px 30px;
            background: linear-gradient(45deg, var(--dynamic-primary), var(--dynamic-secondary));
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
            box-shadow: 0 4px 15px rgba(233, 30, 99, 0.3);
        }
        
        .matching-analyze-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(233, 30, 99, 0.4);
        }
        
        .matching-analyze-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            box-shadow: none;
        }
        
        /* Mobile Responsive for Matching */
        @media (max-width: 768px) {
            .matching-upload-container {
                flex-direction: column;
                gap: 15px;
            }
            
            .matching-vs {
                font-size: 2em;
                transform: rotate(90deg);
            }
            
            .feature-tabs {
                flex-direction: column;
                gap: 5px;
            }
            
            .tab-btn {
                margin: 2px 0;
            }
            
            /* Powerpuff Girls Feature Navigation Mobile */
            .powerpuff-feature-nav {
                flex-wrap: wrap;
                padding: 15px;
                margin: 20px 0;
            }
            
            .feature-character {
                min-width: 80px;
                margin: 5px;
                padding: 10px 15px;
            }
            
            .character-icon {
                font-size: 24px;
            }
            
            .feature-name {
                font-size: 12px;
            }
            
            .character-name {
                font-size: 10px;
            }
        }

        body {
            font-family: 'Nunito', 'Comic Neue', sans-serif;
            background: var(--dynamic-gradient);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite, floatingElements 20s ease-in-out infinite;
            display: flex;
            position: relative;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 10px;
            box-sizing: border-box;
            color: var(--text-color);
            transition: var(--theme-transition);
            overflow-x: hidden;
        }
        
        /* Powerpuff Girls style floating elements */
        body::before {
            content: '‚ú®üíñüåüüí´‚≠ê';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            font-size: 2em;
            color: rgba(255, 105, 180, 0.3);
            pointer-events: none;
            z-index: -1;
            animation: sparkleFloat 25s linear infinite;
        }
        
        @keyframes sparkleFloat {
            0% { transform: translateY(100vh) rotate(0deg); }
            100% { transform: translateY(-100vh) rotate(360deg); }
        }
        
        @keyframes floatingElements {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .container {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.98) 0%, rgba(255, 192, 203, 0.1) 100%);
            padding: 35px 40px;
            border-radius: 30px;
            border: 3px solid rgba(255, 105, 180, 0.3);
            box-shadow: 
                0 15px 35px rgba(255, 105, 180, 0.3),
                0 5px 15px rgba(255, 20, 147, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
            width: 100%;
            max-width: 600px;
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: visible;
            box-sizing: border-box;
            animation: containerFloat 6s ease-in-out infinite;
        }
        
        @keyframes containerFloat {
            0%, 100% { transform: translateY(0px) scale(1); }
            50% { transform: translateY(-5px) scale(1.01); }
        }

        /* Simple decorative dots/sparkles using pseudo-elements */
        .container::before, .container::after {
            content: '';
            position: absolute;
            width: 100px;
            height: 100px;
            background: radial-gradient(circle, rgba(255, 182, 193, 0.3) 20%, transparent 70%);
            border-radius: 50%;
            opacity: 0.5;
            pointer-events: none; /* So they don't interfere with clicks */
            z-index: -1; /* Behind content */
        }

        .container::before {
            top: -30px;
            left: -30px;
            animation: sparkle1 10s infinite linear;
        }

        .container::after {
            bottom: -40px;
            right: -40px;
            width: 150px; /* Different size */
            height: 150px;
            animation: sparkle2 12s infinite linear reverse;
        }

        @keyframes sparkle1 {
            0% { transform: scale(0.8) rotate(0deg); opacity: 0.3; }
            50% { transform: scale(1.2) rotate(180deg); opacity: 0.6; }
            100% { transform: scale(0.8) rotate(360deg); opacity: 0.3; }
        }

        @keyframes sparkle2 {
            0% { transform: scale(1) rotate(0deg); opacity: 0.4; }
            50% { transform: scale(0.7) rotate(-180deg); opacity: 0.7; }
            100% { transform: scale(1) rotate(-360deg); opacity: 0.4; }
        }

        body::after {
            content: 'üòí'; /* Rolling eyes emoji, a classicÂêêÊßΩ face */
            position: fixed; /* Fixed position so it stays in place during scroll */
            font-size: 20vw; /* Reduced size for better mobile experience */
            color: rgba(0, 0, 0, 0.08); /* Reduced opacity for mobile */
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-15deg); /* Centered and slightly rotated */
            z-index: -1; /* Ensure it's behind content but above solid background if any */
            pointer-events: none; /* Make sure it doesn't interfere with clicks */
            animation:ÂêêÊßΩemojiAnimation 5s ease-in-out infinite alternate; /* Added animation */
        }

        @keyframes ÂêêÊßΩemojiAnimation {
            0% {
                transform: translate(-50%, -50%) rotate(-15deg) scale(1);
                opacity: 0.7;
            }
            50% {
                transform: translate(-45%, -55%) rotate(-10deg) scale(1.1);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) rotate(-15deg) scale(1);
                opacity: 0.7;
            }
        }

        @keyframes gradientBG {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }

        h1 {
            font-family: 'Fredoka One', 'Nunito', sans-serif;
            color: #ff1493;
            margin-bottom: 25px;
            font-weight: 400;
            font-size: 2.8em;
            text-shadow: 
                3px 3px 0px #ff69b4,
                6px 6px 0px #ffc0cb,
                9px 9px 15px rgba(255, 20, 147, 0.3);
            animation: powerpuffTitle 4s ease-in-out infinite;
            transform-origin: center;
            letter-spacing: 2px;
        }
        
        h1::before {
            content: 'üíñ ';
            animation: heartBeat 2s ease-in-out infinite;
        }
        
        h1::after {
            content: ' ‚ú®';
            animation: sparkle 3s ease-in-out infinite;
        }

        @keyframes powerpuffTitle {
            0%, 100% {
                transform: scale(1) rotate(0deg);
                text-shadow: 
                    3px 3px 0px #ff69b4,
                    6px 6px 0px #ffc0cb,
                    9px 9px 15px rgba(255, 20, 147, 0.3);
            }
            50% {
                transform: scale(1.05) rotate(1deg);
                text-shadow: 
                    4px 4px 0px #ff69b4,
                    8px 8px 0px #ffc0cb,
                    12px 12px 20px rgba(255, 20, 147, 0.5);
            }
        }
        
        @keyframes heartBeat {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
        
        @keyframes sparkle {
            0%, 100% { transform: rotate(0deg) scale(1); }
            25% { transform: rotate(90deg) scale(1.1); }
            50% { transform: rotate(180deg) scale(1); }
            75% { transform: rotate(270deg) scale(1.1); }
        }

        h2 {
            color: #555;
            margin-top: 30px;
            margin-bottom: 10px;
            font-size: 1.3em;
            text-align: left;
        }

        .upload-section {
            margin-bottom: 30px;
            padding: 25px;
            border: 2px dashed #ffadc5; /* Lighter pink dashed border */
            border-radius: 12px;
            background-color: rgba(255, 240, 245, 0.7); /* Light pinkish transparent */
            transition: all 0.3s ease;
            position: relative;
        }

        .upload-section.drag-over {
            border-color: #e91e63;
            background-color: rgba(233, 30, 99, 0.1);
            transform: scale(1.02);
            box-shadow: 0 5px 15px rgba(233, 30, 99, 0.3);
        }

        .drag-drop-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.2em;
            color: #e91e63;
            font-weight: 600;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
            z-index: 10;
        }

        .upload-section.drag-over .drag-drop-text {
            opacity: 1;
        }

        .upload-section.drag-over .custom-file-upload,
        .upload-section.drag-over #fileName {
            opacity: 0.3;
        }

        input[type="file"] {
            display: none;
        }

        .custom-file-upload {
            background: linear-gradient(45deg, var(--dynamic-secondary) 0%, var(--dynamic-accent) 99%, var(--dynamic-accent) 100%); /* Dynamic gradient */
            color: white;
            padding: 12px 22px;
            border: none;
            border-radius: 25px; /* More rounded */
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: var(--theme-transition);
            display: inline-block;
            box-shadow: 0 4px 10px rgba(255, 154, 158, 0.4);
            position: relative;
            overflow: hidden;
        }

        .custom-file-upload:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 6px 15px rgba(255, 154, 158, 0.6);
            background: linear-gradient(45deg, var(--dynamic-secondary) 0%, var(--dynamic-accent) 50%, var(--dynamic-accent) 100%);
        }

        .custom-file-upload:active {
            transform: translateY(0px) scale(0.98);
            box-shadow: 0 2px 5px rgba(255, 154, 158, 0.4);
        }

        .custom-file-upload::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }

        .custom-file-upload:hover::before {
            left: 100%;
        }

        #fileName {
            margin-top: 15px;
            font-style: normal;
            color: #e91e63;
            font-weight: 600;
        }

        button#submitBtn {
            background: linear-gradient(45deg, var(--dynamic-primary) 0%, var(--dynamic-secondary) 100%); /* Dynamic gradient */
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: var(--theme-transition);
            margin-top: 15px;
            box-shadow: 0 4px 10px rgba(132, 250, 176, 0.4);
        }

        button#submitBtn:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 15px rgba(132, 250, 176, 0.6);
            background: linear-gradient(45deg, #84fab0 0%, #8fd3f4 50%, #a8edea 100%);
        }

        button#submitBtn:active {
            transform: translateY(0px) scale(0.95);
            box-shadow: 0 2px 5px rgba(132, 250, 176, 0.4);
        }

        button#submitBtn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        button#submitBtn:hover::after {
            width: 300px;
            height: 300px;
        }

        button#submitBtn:disabled {
            background: #dcdcdc;
            box-shadow: none;
            transform: none;
            cursor: not-allowed;
        }

        /* Pulse animation for loading state */
        .pulse-loading {
            animation: pulseGlow 1.5s ease-in-out infinite;
            position: relative;
            overflow: hidden;
        }

        .pulse-loading::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes pulseGlow {
            0%, 100% {
                box-shadow: 0 4px 10px rgba(132, 250, 176, 0.4), 0 0 0 0 rgba(132, 250, 176, 0.7);
            }
            50% {
                box-shadow: 0 6px 15px rgba(132, 250, 176, 0.8), 0 0 0 10px rgba(132, 250, 176, 0);
            }
        }

        @keyframes shimmer {
            0% {
                left: -100%;
            }
            100% {
                left: 100%;
            }
        }

        .result-section {
            margin-top: 30px;
            text-align: left;
        }

        /* Typewriter effect */
        .typewriter {
            overflow: hidden;
            border-right: 2px solid #e91e63;
            white-space: nowrap;
            animation: typing 3s steps(40, end), blink-caret 0.75s step-end infinite;
        }

        @keyframes typing {
            from { width: 0; }
            to { width: 100%; }
        }

        @keyframes blink-caret {
            from, to { border-color: transparent; }
            50% { border-color: #e91e63; }
        }

        /* Rating System Styles */
        .rating-section {
            margin-top: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            text-align: center;
            color: white;
        }

        .rating-section h3 {
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .rating-stars {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .star {
            font-size: 2em;
            cursor: pointer;
            transition: all 0.3s ease;
            filter: grayscale(100%);
        }

        .star:hover,
        .star.active {
            filter: grayscale(0%);
            transform: scale(1.2);
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
        }

        .rating-text {
            font-size: 0.9em;
            opacity: 0.8;
        }

        /* Share Section Styles */
        .share-section {
            margin-top: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border-radius: 15px;
            text-align: center;
            color: white;
        }

        .share-section h3 {
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .share-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .share-btn {
            padding: 10px 15px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s ease;
            color: white;
        }

        .share-btn.facebook {
            background: #3b5998;
        }

        .share-btn.twitter {
            background: #1da1f2;
        }

        .share-btn.line {
            background: #00c300;
        }

        .share-btn.copy {
            background: #6c757d;
        }

        .share-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        /* Top Controls */
        .top-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 100;
        }

        .control-btn {
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s ease;
            color: #333;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 1);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        /* History Panel */
        .history-panel {
            margin-bottom: 20px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
            max-height: 400px;
            overflow-y: auto;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
        }

        .history-header h3 {
            margin: 0;
            color: #e91e63;
        }

        .clear-btn {
            padding: 5px 10px;
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.8em;
            transition: all 0.3s ease;
        }

        .clear-btn:hover {
            background: #ff5252;
            transform: scale(1.05);
        }

        /* Action Buttons Styles */
        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .retry-btn, .try-again-btn {
            background: linear-gradient(45deg, #4fc3f7 0%, #29b6f6 100%);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(79, 195, 247, 0.4);
            position: relative;
            overflow: hidden;
        }

        .retry-btn:hover, .try-again-btn:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 15px rgba(79, 195, 247, 0.6);
            background: linear-gradient(45deg, #29b6f6 0%, #1e88e5 100%);
        }

        .retry-btn:active, .try-again-btn:active {
            transform: translateY(0px) scale(0.95);
            box-shadow: 0 2px 5px rgba(79, 195, 247, 0.4);
        }

        .try-again-btn {
            background: linear-gradient(45deg, #66bb6a 0%, #4caf50 100%);
            box-shadow: 0 4px 10px rgba(102, 187, 106, 0.4);
        }

        .try-again-btn:hover {
            background: linear-gradient(45deg, #4caf50 0%, #388e3c 100%);
            box-shadow: 0 6px 15px rgba(102, 187, 106, 0.6);
        }

        .history-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .history-item {
            display: flex;
            gap: 15px;
            padding: 15px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #e91e63;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .history-item:hover {
            background: #e3f2fd;
            transform: translateX(5px);
        }

        .history-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
            flex-shrink: 0;
        }

        .history-content {
            flex: 1;
        }

        .history-date {
            font-size: 0.8em;
            color: #666;
            margin-bottom: 5px;
        }

        .history-comment {
            font-size: 0.9em;
            color: #333;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .no-history {
            text-align: center;
            color: #999;
            font-style: italic;
            padding: 20px;
        }

        /* Dark Theme */
        body.dark-theme {
            background: linear-gradient(-45deg, #2c3e50, #34495e, #2c3e50, #34495e);
            color: #ecf0f1;
        }

        body.dark-theme .container {
            background-color: rgba(52, 73, 94, 0.95);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        body.dark-theme h1 {
            color: #e74c3c;
        }

        body.dark-theme .upload-section {
            background-color: rgba(44, 62, 80, 0.8);
            border-color: #e74c3c;
        }

        body.dark-theme .custom-file-upload {
            background: linear-gradient(45deg, #e74c3c 0%, #c0392b 100%);
        }

        body.dark-theme button#submitBtn {
            background: linear-gradient(45deg, #e74c3c 0%, #c0392b 100%);
        }

        body.dark-theme .history-panel {
            background: rgba(52, 73, 94, 0.95);
        }

        body.dark-theme .history-item {
            background: rgba(44, 62, 80, 0.8);
            border-left-color: #e74c3c;
        }

        body.dark-theme .history-item:hover {
            background: rgba(52, 73, 94, 0.9);
        }

        body.dark-theme .control-btn {
            background: rgba(52, 73, 94, 0.9);
            color: #ecf0f1;
        }

        body.dark-theme .control-btn:hover {
            background: rgba(44, 62, 80, 1);
        }

        /* Dark Theme for Introduction Section */
        body.dark-theme .intro-section {
            background: rgba(44, 62, 80, 0.9);
            border-color: #e74c3c;
        }

        body.dark-theme .intro-section h2 {
            color: #e74c3c;
        }

        body.dark-theme .intro-toggle {
            background: rgba(231, 76, 60, 0.2);
            color: #ecf0f1;
            border-color: #e74c3c;
        }

        body.dark-theme .intro-toggle:hover {
            background: rgba(231, 76, 60, 0.3);
            transform: translateY(-2px);
        }

        body.dark-theme .intro-description {
            color: #bdc3c7;
        }

        body.dark-theme .feature-item {
            background: rgba(52, 73, 94, 0.8);
            border-color: #34495e;
        }

        body.dark-theme .feature-item:hover {
            background: rgba(52, 73, 94, 0.95);
            border-color: #e74c3c;
            transform: translateY(-5px);
        }

        body.dark-theme .feature-item h3 {
            color: #e74c3c;
        }

        body.dark-theme .feature-item p {
            color: #bdc3c7;
        }

        body.dark-theme .quick-tips {
            background: rgba(52, 73, 94, 0.8);
            border-color: #e74c3c;
        }

        body.dark-theme .quick-tips h4 {
            color: #e74c3c;
        }

        body.dark-theme .quick-tips li {
            color: #bdc3c7;
        }

        body.dark-theme .future-features {
            background: rgba(52, 73, 94, 0.8);
            border-color: #e74c3c;
        }

        body.dark-theme .future-features h4 {
            color: #e74c3c;
        }

        body.dark-theme .coming-soon-item {
            background: rgba(44, 62, 80, 0.8);
            border-color: #34495e;
        }

        body.dark-theme .coming-soon-item:hover {
            background: rgba(231, 76, 60, 0.2);
            border-color: #e74c3c;
            transform: translateY(-3px);
        }

        body.dark-theme .coming-icon {
            color: #e74c3c;
        }

        body.dark-theme .coming-soon-item span:last-child {
            color: #bdc3c7;
        }

        /* Advanced Panel Styles */
        .advanced-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.98);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            z-index: 1000;
            min-width: 400px;
            max-width: 90vw;
        }

        .advanced-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 15px;
        }

        .advanced-header h3 {
            margin: 0;
            color: #e91e63;
            font-size: 1.3em;
        }

        .close-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 1.1em;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: #ff5252;
            transform: scale(1.1);
        }

        .setting-group {
            margin-bottom: 25px;
        }

        .setting-label {
            display: block;
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
            font-size: 1.1em;
        }

        .style-options, .language-options {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .style-btn, .lang-btn {
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            color: #666;
        }

        .style-btn.active, .lang-btn.active {
            background: linear-gradient(45deg, #e91e63 0%, #f06292 100%);
            color: white;
            border-color: #e91e63;
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(233, 30, 99, 0.4);
            font-weight: 700;
        }

        .style-btn:hover, .lang-btn:hover {
            border-color: #e91e63;
            transform: translateY(-2px);
        }

        .settings-toggle {
            text-align: center;
            margin-bottom: 20px;
        }

        .settings-btn {
            padding: 10px 20px;
            background: linear-gradient(45deg, #9c27b0 0%, #e91e63 100%);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(156, 39, 176, 0.3);
        }

        .settings-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(156, 39, 176, 0.4);
        }

        /* Filter Preview Styles */
        .filter-preview {
            margin-top: 20px;
            padding: 20px;
            background: rgba(248, 249, 250, 0.9);
            border-radius: 15px;
            border: 2px dashed #e91e63;
        }

        .filter-header {
            text-align: center;
            margin-bottom: 15px;
        }

        .filter-header h4 {
            margin: 0;
            color: #e91e63;
            font-size: 1.1em;
        }

        .filter-container {
            text-align: center;
        }

        .filter-canvas {
            max-width: 100%;
            max-height: 200px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 15px;
        }

        .filter-controls {
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 20px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
            font-weight: 600;
            color: #666;
        }

        .filter-btn.active {
            background: linear-gradient(45deg, #ff9800 0%, #f57c00 100%);
            color: white;
            border-color: #ff9800;
        }

        .filter-btn:hover {
            border-color: #ff9800;
            transform: scale(1.05);
        }

        /* Dark Theme for Advanced Features */
        body.dark-theme .advanced-panel {
            background: rgba(52, 73, 94, 0.98);
            color: #ecf0f1;
        }

        body.dark-theme .setting-label {
            color: #ecf0f1;
        }

        body.dark-theme .style-btn, 
        body.dark-theme .lang-btn,
        body.dark-theme .filter-btn {
            background: rgba(44, 62, 80, 0.8);
            border-color: #5a6c7d;
            color: #ecf0f1;
        }

        body.dark-theme .style-btn.active,
        body.dark-theme .lang-btn.active {
            background: linear-gradient(45deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            border-color: #e74c3c;
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
            font-weight: 700;
        }

        body.dark-theme .filter-btn.active {
            background: linear-gradient(45deg, #f39c12 0%, #e67e22 100%);
            color: white;
            border-color: #f39c12;
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(243, 156, 18, 0.4);
        }

        body.dark-theme .style-btn:hover,
        body.dark-theme .lang-btn:hover,
        body.dark-theme .filter-btn:hover {
            border-color: #e74c3c;
            transform: translateY(-2px);
            background: rgba(52, 73, 94, 0.9);
        }

        body.dark-theme .filter-preview {
            background: rgba(44, 62, 80, 0.9);
            border-color: #e74c3c;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .advanced-panel {
                min-width: 90vw;
                padding: 20px;
            }
            
            .style-options, .language-options {
                justify-content: center;
            }
            
            .filter-preview {
                margin-top: 15px;
                padding: 15px;
            }
            
            .filter-canvas {
                max-width: 100%;
                max-height: 250px;
                min-height: 150px;
                width: auto;
                height: auto;
            }
            
            .filter-controls {
                gap: 8px;
                margin-top: 15px;
            }
            
            .filter-btn {
                padding: 8px 12px;
                font-size: 0.85em;
                min-width: 60px;
            }
        }
        
        @media (max-width: 480px) {
            .filter-preview {
                margin-top: 10px;
                padding: 10px;
            }
            
            .filter-canvas {
                max-width: 100%;
                max-height: 200px;
                min-height: 120px;
                width: auto;
                height: auto;
            }
            
            .filter-controls {
                gap: 6px;
                margin-top: 10px;
            }
            
            .filter-btn {
                padding: 6px 10px;
                font-size: 0.8em;
                min-width: 50px;
                flex: 1;
                max-width: calc(50% - 3px);
            }
            
            .filter-header h4 {
                font-size: 1em;
            }
        }

        #imagePreviewContainer {
            margin-bottom: 20px;
            border: 1px solid #ffe0e9; /* Light pink border */
            padding: 15px;
            border-radius: 12px;
            background-color: #fffafa;
            min-height: 150px;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden; /* Ensure image fits */
        }

        #imagePreview {
            max-width: 100%;
            max-height: 350px;
            border-radius: 8px;
            object-fit: contain; /* Ensure image aspect ratio is maintained */
        }

        /* Fix for uploaded image display */
        #imagePreview img {
            max-width: 100%;
            max-height: 400px;
            object-fit: contain !important; /* Prevent cropping */
            border-radius: 10px;
            display: block;
            margin: 0 auto;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        #aiComment {
            background-color: #e6fff2; /* Slightly more vibrant mint green */
            padding: 25px;
            border-radius: 15px; /* Slightly more rounded */
            min-height: 70px;
            color: #1e5926; /* Darker, richer green for text */
            white-space: pre-wrap;
            border: 2px dashed #a3d9b1; /* Dashed border for a bit of fun */
            font-size: 1.1em; /* Slightly larger font */
            line-height: 1.7;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05); /* Subtle shadow */
            position: relative; /* For loading indicator */
            transition: background-color 0.3s ease; /* Smooth transition for loading state */
        }

        #aiComment.loading {
            display: flex;
            align-items: center;
            justify-content: center;
            color: transparent; /* Hide text during loading */
        }

        #aiComment.loading::after {
            content: '';
            display: block;
            width: 40px;
            height: 40px;
            border: 5px solid #a3d9b1; /* Light green border */
            border-top-color: #1e5926; /* Darker green for spinner part */
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-spinner {
            border: 5px solid #fce4ec; /* Light pink */
            border-top: 5px solid #e91e63; /* Pink */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 25px auto;
            display: none;
        }

        /* Improved loading overlay */
        .loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(2px);
        }

        .loading-content {
            text-align: center;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #fce4ec;
            border-top: 5px solid #e91e63;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            color: #d9534f; /* Standard error red */
            background-color: #fddfee; /* Light pink error background */
            border: 1px solid #d9534f;
            padding: 10px;
            border-radius: 8px;
            margin-top: 15px;
        }

        /* Adding some playful touches to the file input */
        input[type="file"] {
            color: transparent; /* Hide default text */
        }
        input[type="file"]::before {
            content: '‚ú® ÈÅ∏Êìá‰∏ÄÂºµÁÖßÁâá ‚ú®'; /* Playful text */
            color: #e83e8c;
            display: inline-block;
            background: -webkit-linear-gradient(#e83e8c, #ff85a2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: bold;
            margin-right: 10px;
        }

        /* Large screens optimization */
        @media (min-width: 1200px) {
            .container {
                max-width: 700px;
                padding: 50px;
            }
            
            .upload-section, .result-section {
                margin-bottom: 30px;
            }
            
            h1 {
                text-align: center;
                margin-bottom: 30px;
            }
            
            .top-controls {
                margin-bottom: 20px;
            }
        }

        /* Tablet optimization */
        @media (min-width: 769px) and (max-width: 1199px) {
            .container {
                max-width: 800px;
                padding: 40px;
            }
            
            .share-buttons, .warning-buttons {
                justify-content: space-between;
            }
            
            .filter-controls {
                gap: 12px;
            }
            
            .advanced-settings {
                grid-template-columns: 1fr 1fr;
                gap: 20px;
            }
        }

        /* Mobile and small tablet adjustments */
        @media (max-width: 768px) {
            body {
                padding: 5px;
                overflow-x: hidden;
            }
            
            body::after {
                font-size: 15vw;
                color: rgba(0, 0, 0, 0.05);
            }
            
            .container {
                padding: 20px 15px;
                margin: 5px;
                max-width: calc(100vw - 20px);
                border-radius: 15px;
                overflow-x: hidden;
            }
            
            h1 {
                font-size: 1.6em;
                margin-bottom: 20px;
            }
            
            .upload-section {
                padding: 15px;
                margin-bottom: 20px;
                position: relative;
                overflow: hidden;
            }
            
            .upload-section.drag-over {
                transform: none; /* Prevent scaling on mobile */
            }
            
            button, input[type="file"]::file-selector-button {
                padding: 12px 20px;
                font-size: 0.9em;
                width: 100%;
                box-sizing: border-box;
            }
            
            .custom-file-upload {
                width: 100%;
                text-align: center;
                box-sizing: border-box;
            }
            
            #fileName {
                word-break: break-word;
                text-align: center;
            }
            
            .top-controls {
                gap: 8px;
                right: 10px;
                top: 10px;
                flex-wrap: wrap;
            }

            .control-btn {
                padding: 6px 10px;
                font-size: 0.8em;
                white-space: nowrap;
            }
            
            .share-buttons, .warning-buttons {
                flex-direction: column;
                width: 100%;
            }
            
            .share-btn, .compress-btn, .continue-btn, .cancel-btn {
                width: 100%;
                margin: 2px 0;
            }
            
            /* Prevent horizontal scrolling */
            * {
                max-width: 100%;
                box-sizing: border-box;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 2px;
            }
            
            body::after {
                font-size: 12vw; /* Even smaller on very small screens */
                color: rgba(0, 0, 0, 0.03);
            }
            
            h1 {
                font-size: 1.4em;
                margin-bottom: 15px;
            }
            
            /* Extra small screens - Powerpuff Girls Feature Navigation */
            .powerpuff-feature-nav {
                padding: 10px;
                margin: 15px 0;
                flex-direction: column;
                align-items: center;
            }
            
            .feature-character {
                width: 90%;
                max-width: 200px;
                margin: 8px 0;
                padding: 12px;
                flex-direction: row;
                justify-content: flex-start;
                text-align: left;
            }
            
            .character-icon {
                font-size: 20px;
                margin-right: 10px;
                margin-bottom: 0;
            }
            
            .feature-text {
                display: flex;
                flex-direction: column;
            }
            
            .feature-name {
                font-size: 14px;
                margin-bottom: 2px;
            }
            
            .character-name {
                font-size: 11px;
            }
            
            .container {
                border-radius: 12px;
                padding: 15px 10px;
                margin: 2px;
                max-width: calc(100vw - 10px);
            }
            
            .upload-section {
                padding: 10px;
                margin-bottom: 15px;
            }
            
            button, input[type="file"]::file-selector-button {
                width: 100%;
                padding: 10px;
                font-size: 0.85em;
            }

            .top-controls .control-btn {
                width: auto; /* Override the 100% width for top control buttons */
                padding: 5px 8px; /* Further adjust padding for very small screens */
                font-size: 0.75em; /* Further adjust font size */
            }
            
            #uploadForm {
                display: flex;
                flex-direction: column;
                align-items: center;
            }
            
            #imagePreview {
                max-height: 180px;
            }
            
            #aiComment {
                font-size: 0.85em;
                padding: 12px;
                line-height: 1.4;
            }
            
            /* Make sparkles smaller on mobile */
            .container::before, .container::after {
                width: 40px;
                height: 40px;
            }
            
            .container::after {
                width: 60px;
                height: 60px;
            }
        }

        /* Progress Bar Styles */
        .progress-container {
            width: 100%;
            background-color: #f0f0f0;
            border-radius: 10px;
            margin-top: 15px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar {
            height: 8px;
            background: linear-gradient(45deg, #84fab0 0%, #8fd3f4 100%);
            border-radius: 10px;
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.8em;
            font-weight: 600;
            color: #666;
        }

        .loading-content {
            text-align: center;
        }

        /* File Size Warning Styles */
        .file-size-warning {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .warning-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .warning-content h3 {
            color: #ff9800;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .warning-content p {
            color: #666;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .warning-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .compress-btn, .continue-btn, .cancel-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .compress-btn {
            background: linear-gradient(45deg, #4CAF50 0%, #45a049 100%);
            color: white;
        }

        .continue-btn {
            background: linear-gradient(45deg, #ff9800 0%, #f57c00 100%);
            color: white;
        }

        .cancel-btn {
            background: linear-gradient(45deg, #f44336 0%, #d32f2f 100%);
            color: white;
        }

        .compress-btn:hover, .continue-btn:hover, .cancel-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        /* Enhanced Error Message Styles */
        .error-message {
            background: linear-gradient(45deg, #ffebee 0%, #ffcdd2 100%);
            border: 2px solid #f44336;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            color: #d32f2f;
            font-weight: 600;
            text-align: center;
            box-shadow: 0 4px 15px rgba(244, 67, 54, 0.2);
        }

        .error-message .error-title {
            font-size: 1.1em;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .error-message .error-suggestion {
             font-size: 0.9em;
             color: #666;
             margin-top: 10px;
             font-weight: normal;
         }

        /* Introduction Section Styles */
        .intro-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            padding: 30px;
            margin: 20px 0;
            color: white;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }

        .intro-section::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            pointer-events: none;
        }

        .intro-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
        }

        .intro-section h2 {
            font-size: 1.8em;
            margin: 0;
            font-weight: 600;
            flex: 1;
        }

        .intro-toggle {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .intro-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .intro-content {
            position: relative;
            z-index: 1;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .intro-description {
            font-size: 1.1em;
            line-height: 1.6;
            text-align: center;
            margin-bottom: 30px;
            opacity: 0.95;
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .feature-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .feature-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
        }

        .feature-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
            display: block;
        }

        .feature-item h3 {
            font-size: 1.2em;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .feature-item p {
            font-size: 0.9em;
            opacity: 0.9;
            line-height: 1.4;
        }

        .quick-tips {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-top: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .quick-tips h4 {
            font-size: 1.1em;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .quick-tips ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .quick-tips li {
            padding: 8px 0;
            padding-left: 25px;
            position: relative;
            font-size: 0.95em;
            line-height: 1.4;
        }

        .quick-tips li::before {
            content: 'üí°';
            position: absolute;
            left: 0;
            top: 8px;
        }

        .future-features {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .future-features h4 {
            font-size: 1.1em;
            margin-bottom: 15px;
            font-weight: 600;
            text-align: center;
        }

        .coming-soon-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .coming-soon-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px 10px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .coming-soon-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-3px);
        }

        .coming-icon {
            font-size: 1.5em;
            display: block;
            margin-bottom: 8px;
        }

        .coming-soon-item span:last-child {
            font-size: 0.9em;
            font-weight: 500;
        }
        
        /* Special styling for fortune prediction */
        .coming-soon-item:first-child {
            background: linear-gradient(135deg, rgba(138, 43, 226, 0.2), rgba(75, 0, 130, 0.2));
            border: 1px solid rgba(138, 43, 226, 0.4);
            position: relative;
            overflow: hidden;
        }
        
        .coming-soon-item:first-child::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transform: rotate(45deg);
            animation: shimmer 3s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }
        
        .coming-soon-item:first-child:hover {
            background: linear-gradient(135deg, rgba(138, 43, 226, 0.3), rgba(75, 0, 130, 0.3));
            box-shadow: 0 5px 20px rgba(138, 43, 226, 0.4);
        }
        
        /* Fortune prediction result styling */
        .fortune-result {
            background: linear-gradient(135deg, rgba(138, 43, 226, 0.1), rgba(75, 0, 130, 0.1));
            border: 2px solid rgba(138, 43, 226, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            position: relative;
            overflow: hidden;
        }
        
        .fortune-result::before {
            content: 'üîÆ';
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 1.5em;
            opacity: 0.6;
        }
        
        .fortune-result .ai-comment {
            color: #e6e6fa;
            text-shadow: 0 0 10px rgba(138, 43, 226, 0.5);
        }

        /* Mobile responsive for intro section */
        @media (max-width: 768px) {
            .intro-section {
                padding: 20px 15px;
                margin: 15px 0;
            }

            .intro-header {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }

            .intro-section h2 {
                font-size: 1.5em;
                text-align: center;
            }

            .intro-toggle {
                align-self: center;
                font-size: 0.85em;
                padding: 6px 12px;
            }

            .intro-description {
                font-size: 1em;
            }

            .features-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 15px;
                margin: 20px 0;
            }

            .feature-item {
                padding: 15px;
            }

            .feature-icon {
                font-size: 2em;
            }

            .feature-item h3 {
                font-size: 1.1em;
            }

            .feature-item p {
                font-size: 0.85em;
            }

            .quick-tips {
                padding: 15px;
            }

            .quick-tips li {
                font-size: 0.9em;
            }

            .future-features {
                padding: 15px;
            }

            .coming-soon-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .coming-soon-item {
                padding: 12px 8px;
            }

            .coming-icon {
                font-size: 1.3em;
            }

            .coming-soon-item span:last-child {
                font-size: 0.8em;
            }
        }

        /* Special analysis type styles */
        .detailed-report {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border: 2px solid #00bcd4;
            box-shadow: 0 0 20px rgba(0, 188, 212, 0.3);
        }
        
        .detailed-report h2 {
            color: #00bcd4;
            text-shadow: 0 0 10px rgba(0, 188, 212, 0.5);
        }
        
        .emotion-analysis {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            border: 2px solid #ff6b9d;
            box-shadow: 0 0 20px rgba(255, 107, 157, 0.3);
        }
        
        .emotion-analysis h2 {
            color: #ff6b9d;
            text-shadow: 0 0 10px rgba(255, 107, 157, 0.5);
        }

        /* Notification animations */
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Theme Toggle and History Button -->
        <div class="top-controls">
            <button id="themeToggle" class="control-btn">üåô ÊöóËâ≤‰∏ªÈ°å</button>
            <button id="historyToggle" class="control-btn">üìö ÂàÜÊûêË®òÈåÑ</button>
        </div>
        
        <!-- Advanced Settings Panel -->
        <div id="advancedPanel" class="advanced-panel" style="display: none;">
            <div class="advanced-header">
                <h3>‚öôÔ∏è ÈÄ≤ÈöéË®≠ÂÆö</h3>
                <button id="closeAdvanced" class="close-btn">‚úï</button>
            </div>
            
            <!-- Comment Style Selection -->
            <div class="setting-group">
                <label class="setting-label">üîç ÂàÜÊûêÈ¢®Ê†º</label>
                <div class="style-buttons">
                    <button class="style-btn active" data-style="mild">üòä Âü∫Á§éÂàÜÊûê</button>
                    <button class="style-btn" data-style="medium">üßê Ë©≥Á¥∞ÂàÜÊûê</button>
                    <button class="style-btn" data-style="spicy">üéØ Ê∑±Â∫¶ÂàÜÊûê</button>
                </div>
            </div>
            
            <!-- Language Selection -->
            <div class="setting-group">
                <label class="setting-label">üåç Ë™ûË®ÄÈÅ∏Êìá</label>
                <div class="language-options">
                    <button class="lang-btn active" data-lang="zh">üáπüáº ÁπÅÈ´î‰∏≠Êñá</button>
                    <button class="lang-btn" data-lang="en">üá∫üá∏ English</button>
                    <button class="lang-btn" data-lang="ja">üáØüáµ Êó•Êú¨Ë™û</button>
                </div>
            </div>
        </div>
        
        <h1>üîç AI Èù¢Áõ∏ÂàÜÊûêÂô® üë§</h1>
        
        <!-- Powerpuff Girls Style Feature Selection -->
        <div class="powerpuff-feature-nav">
            <div class="feature-character blossom active" data-feature="analysis">
                <div class="character-icon">üå∏</div>
                <div class="feature-text">
                    <div class="feature-name">Èù¢Áõ∏ÂàÜÊûê</div>
                    <div class="character-name">Blossom</div>
                </div>
            </div>
            <div class="feature-character bubbles" data-feature="emotion">
                <div class="character-icon">üé≠</div>
                <div class="feature-text">
                    <div class="feature-name">ÊÉÖÁ∑íË≠òÂà•</div>
                    <div class="character-name">Bubbles</div>
                </div>
            </div>
            <div class="feature-character buttercup" data-feature="detailed">
                <div class="character-icon">üìä</div>
                <div class="feature-text">
                    <div class="feature-name">Ë©≥Á¥∞Â†±Âëä</div>
                    <div class="character-name">Buttercup</div>
                </div>
            </div>
            <div class="feature-character professor" data-feature="fortune">
                <div class="character-icon">üîÆ</div>
                <div class="feature-text">
                    <div class="feature-name">ÈÅãÂã¢È†êÊ∏¨</div>
                    <div class="character-name">Professor</div>
                </div>
            </div>
            <div class="feature-character mojo" data-feature="matching">
                <div class="character-icon">üíë</div>
                <div class="feature-text">
                    <div class="feature-name">ÈÖçÂ∞çÂàÜÊûê</div>
                    <div class="character-name">Mojo</div>
                </div>
            </div>
        </div>
        
        <!-- Introduction Section -->
        <div class="intro-section" id="introSection">
            <div class="intro-header">
                <h2>‚ú® AI Êô∫ËÉΩÈù¢Áõ∏ÂàÜÊûêÁ≥ªÁµ±</h2>
                <button class="intro-toggle" id="introToggle">üìñ Â±ïÈñãË©≥ÊÉÖ</button>
            </div>
            
            <div class="intro-content" id="introContent" style="display: none;">
                <p class="intro-description">
                    ÈÅãÁî®ÂÖàÈÄ≤ÁöÑ‰∫∫Â∑•Êô∫ËÉΩÊäÄË°ìÔºåÁÇ∫ÊÇ®Êèê‰æõÂ∞àÊ•≠„ÄÅÊ∫ñÁ¢∫ÁöÑÈù¢Áõ∏ÂàÜÊûêÊúçÂãô„ÄÇ
                    Âè™ÈúÄ‰∏äÂÇ≥‰∏ÄÂºµÊ∏ÖÊô∞ÁöÑ‰∫∫ÂÉèÁÖßÁâáÔºåAI Â∞áÂæûÂ§öÂÄãÁ∂≠Â∫¶ÁÇ∫ÊÇ®Ëß£ËÆÄÈù¢ÈÉ®ÁâπÂæµÊâÄËòäÂê´ÁöÑÊÄßÊ†ºÁâπË≥™ËàáÈÅãÂã¢‰ø°ÊÅØ„ÄÇ
                </p>
                
                <div class="features-grid">
                    <div class="feature-item">
                        <div class="feature-icon">üéØ</div>
                        <h3>Á≤æÊ∫ñÂàÜÊûê</h3>
                        <p>AI Ê∑±Â∫¶Â≠∏ÁøíÁÆóÊ≥ïÔºåÂ§öÁ∂≠Â∫¶Ëß£ËÆÄÈù¢ÈÉ®ÁâπÂæµ</p>
                    </div>
                    <div class="feature-item">
                        <div class="feature-icon">‚ö°</div>
                        <h3>Âø´ÈÄüÈüøÊáâ</h3>
                        <p>ÁßíÁ¥öÂàÜÊûêÈÄüÂ∫¶ÔºåÂç≥ÊôÇÁç≤ÂæóÂ∞àÊ•≠Èù¢Áõ∏Â†±Âëä</p>
                    </div>
                    <div class="feature-item">
                        <div class="feature-icon">üîí</div>
                        <h3>Èö±ÁßÅ‰øùË≠∑</h3>
                        <p>Êú¨Âú∞ËôïÁêÜÊäÄË°ìÔºåÁ¢∫‰øùÊÇ®ÁöÑÁÖßÁâáÂÆâÂÖ®ÁÑ°ÊÜÇ</p>
                    </div>
                    <div class="feature-item">
                        <div class="feature-icon">üé®</div>
                        <h3>Â§öÊ®£ÂäüËÉΩ</h3>
                        <p>ÊøæÈè°ÁæéÂåñ„ÄÅÊ≠∑Âè≤Ë®òÈåÑ„ÄÅÂ§öË™ûË®ÄÊîØÊè¥</p>
                    </div>
                </div>
                
                <div class="quick-tips">
                    <h4>üìù ‰ΩøÁî®Â∞èË≤ºÂ£´</h4>
                    <ul>
                        <li>Ë´ã‰∏äÂÇ≥Ê≠£Èù¢„ÄÅÂÖâÁ∑öÂÖÖË∂≥ÁöÑ‰∫∫ÂÉèÁÖßÁâá</li>
                        <li>Âª∫Ë≠∞ÁÖßÁâáËß£ÊûêÂ∫¶‰∏ç‰ΩéÊñº 500x500 ÂÉèÁ¥†</li>
                        <li>ÊîØÊè¥ JPG„ÄÅPNG Ê†ºÂºèÔºåÊ™îÊ°àÂ§ßÂ∞èÂª∫Ë≠∞Âú® 10MB ‰ª•ÂÖß</li>
                        <li>ÂèØ‰ΩøÁî®ÊøæÈè°ÂäüËÉΩÁæéÂåñÁÖßÁâáÊïàÊûú</li>
                    </ul>
                </div>
                
                <div class="future-features">
                    <h4>üöÄ Âç≥Â∞áÊé®Âá∫ÁöÑÂäüËÉΩ</h4>
                    <div class="coming-soon-grid">
                        <div class="coming-soon-item">
                            <span class="coming-icon">üîÆ</span>
                            <span>ÈÅãÂã¢È†êÊ∏¨</span>
                        </div>
                        <div class="coming-soon-item">
                            <span class="coming-icon">üíë</span>
                            <span>ÈÖçÂ∞çÂàÜÊûê</span>
                        </div>
                        <div class="coming-soon-item">
                            <span class="coming-icon">üìä</span>
                            <span>Ë©≥Á¥∞Â†±Âëä</span>
                        </div>
                        <div class="coming-soon-item">
                            <span class="coming-icon">üé≠</span>
                            <span>ÊÉÖÁ∑íË≠òÂà•</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- History Panel -->
        <div id="historyPanel" class="history-panel" style="display: none;">
            <div class="history-header">
                <h3>üìö ÂàÜÊûêË®òÈåÑ</h3>
                <button id="clearHistory" class="clear-btn">üóëÔ∏è Ê∏ÖÁ©∫</button>
            </div>
            <div id="historyList" class="history-list">
                <p class="no-history">ÈÇÑÊ≤íÊúâÂàÜÊûêË®òÈåÑ</p>
            </div>
        </div>
        <!-- Advanced Settings Toggle -->
        <div class="settings-toggle">
            <button id="advancedToggle" class="settings-btn">‚öôÔ∏è ÈÄ≤ÈöéË®≠ÂÆö</button>
        </div>
        
        <!-- Matching Analysis Section -->
        <div id="matchingSection" class="matching-section" style="display: none;">
            <div class="matching-intro">
                <h3>üíë AI ÈÖçÂ∞çÂàÜÊûê</h3>
                <p>‰∏äÂÇ≥ÂÖ©ÂºµÁÖßÁâáÔºåAI Â∞áÂàÜÊûê‰Ω†ÂÄëÁöÑÈù¢Áõ∏Áõ∏ÂÆπÊÄßÂíåÈÖçÂ∞çÊåáÊï∏</p>
            </div>
            
            <div class="matching-upload-container">
                <div class="matching-upload-item">
                    <h4>üë§ Á¨¨‰∏Ä‰Ωç</h4>
                    <div class="upload-section matching-upload" id="matchingUpload1">
                        <div class="drag-drop-text">üìÅ ÊîæÈñã‰ª•‰∏äÂÇ≥Á¨¨‰∏ÄÂºµÁÖßÁâá</div>
                        <label for="matchingImage1" class="custom-file-upload">ÈÅ∏ÊìáÁÖßÁâá</label>
                        <input type="file" id="matchingImage1" name="image1" accept="image/jpeg, image/png, image/jpg">
                        <span id="matchingFileName1">Â∞öÊú™ÈÅ∏Êìá‰ªª‰ΩïÊ™îÊ°à</span>
                        <div id="matchingPreview1" class="matching-preview"></div>
                    </div>
                </div>
                
                <div class="matching-vs">üíï</div>
                
                <div class="matching-upload-item">
                    <h4>üë§ Á¨¨‰∫å‰Ωç</h4>
                    <div class="upload-section matching-upload" id="matchingUpload2">
                        <div class="drag-drop-text">üìÅ ÊîæÈñã‰ª•‰∏äÂÇ≥Á¨¨‰∫åÂºµÁÖßÁâá</div>
                        <label for="matchingImage2" class="custom-file-upload">ÈÅ∏ÊìáÁÖßÁâá</label>
                        <input type="file" id="matchingImage2" name="image2" accept="image/jpeg, image/png, image/jpg">
                        <span id="matchingFileName2">Â∞öÊú™ÈÅ∏Êìá‰ªª‰ΩïÊ™îÊ°à</span>
                        <div id="matchingPreview2" class="matching-preview"></div>
                    </div>
                </div>
            </div>
            
            <button type="button" id="matchingAnalyzeBtn" class="matching-analyze-btn" disabled>ÈñãÂßãÈÖçÂ∞çÂàÜÊûêÔºÅ</button>
        </div>
        
        <form id="uploadForm" enctype="multipart/form-data">
            <div class="upload-section" id="uploadSection">
                <div class="drag-drop-text">üìÅ ÊîæÈñã‰ª•‰∏äÂÇ≥‰∫∫ÂÉèÁÖßÁâá</div>
                <label for="imageUpload" class="custom-file-upload">ÈÅ∏Êìá‰∫∫ÂÉèÁÖßÁâá</label>
                <input type="file" id="imageUpload" name="image" accept="image/jpeg, image/png, image/jpg" required>
                <span id="fileName">Â∞öÊú™ÈÅ∏Êìá‰ªª‰ΩïÊ™îÊ°à</span>
                
                <!-- Image Filter Preview -->
                <div id="filterPreview" class="filter-preview" style="display: none;">
                    <div class="filter-header">
                        <h4>üé® ÊøæÈè°È†êË¶Ω</h4>
                    </div>
                    <div class="filter-container">
                        <canvas id="filterCanvas" class="filter-canvas"></canvas>
                        <div class="filter-controls">
                            <button type="button" class="filter-btn active" data-filter="none">ÂéüÂúñ</button>
                            <button type="button" class="filter-btn" data-filter="vintage">Âæ©Âè§</button>
                            <button type="button" class="filter-btn" data-filter="bw">ÈªëÁôΩ</button>
                            <button type="button" class="filter-btn" data-filter="sepia">Êá∑Ëàä</button>
                            <button type="button" class="filter-btn" data-filter="bright">Êòé‰∫Æ</button>
                            <button type="button" class="filter-btn" data-filter="contrast">Â∞çÊØî</button>
                        </div>
                    </div>
                </div>
            </div>
            <button type="submit" id="submitBtn">ÈñãÂßãÈù¢Áõ∏ÂàÜÊûêÔºÅ</button>
        </form>

        <div id="loading" class="loader" style="display: none;">
            <div class="loading-content">
                <div class="spinner"></div>
                <p>AI Ê≠£Âú®ÂàÜÊûêÈù¢Áõ∏‰∏≠...</p>
                <div class="progress-container">
                    <div class="progress-bar" id="progressBar"></div>
                    <div class="progress-text" id="progressText">0%</div>
                </div>
            </div>
        </div>
        
        <!-- File size warning -->
        <div id="fileSizeWarning" class="file-size-warning" style="display: none;">
            <div class="warning-content">
                <h3>‚ö†Ô∏è Ê™îÊ°àËºÉÂ§ß</h3>
                <p id="fileSizeMessage"></p>
                <div class="warning-buttons">
                    <button id="compressBtn" class="compress-btn">ÂÑ™ÂåñÂúñÁâá</button>
                    <button id="continueBtn" class="continue-btn">ÁπºÁ∫å‰∏äÂÇ≥</button>
                    <button id="cancelBtn" class="cancel-btn">ÂèñÊ∂à</button>
                </div>
            </div>
        </div>
        
        <div id="errorDisplay" class="error-message" style="display: none;"></div>

        <div id="imagePreview" class="image-preview-container">
            <!-- Uploaded image will be shown here -->
        </div>

        <div id="aiResponseContainer" style="display: none;">
            <h2>üîç AI Â∞àÊ•≠Èù¢Áõ∏ÂàÜÊûêÔºö</h2>
            <div id="aiResponse" class="ai-comment-box"></div>
            
            <!-- Action Buttons -->
            <div class="action-buttons" style="margin: 20px 0; text-align: center;">
                <button id="retryBtn" class="retry-btn" onclick="resetAnalysis()">üîÑ ÈáçÊñ∞ÈÅ∏ÊìáÂúñÁâá</button>
                <button id="tryAgainBtn" class="try-again-btn" onclick="tryAgain()" style="display: none;">üéØ ÂÜçË©¶‰∏ÄÊ¨°</button>
            </div>
            
            <!-- Rating System -->
            <div id="ratingSection" class="rating-section" style="display: none;">
                <h3>‚≠ê ÂàÜÊûêÊªøÊÑèÂ∫¶Ë©ïÂàÜÔºö</h3>
                <div class="rating-stars">
                    <span class="star" data-rating="1">üíÄ</span>
                    <span class="star" data-rating="2">üíÄ</span>
                    <span class="star" data-rating="3">üíÄ</span>
                    <span class="star" data-rating="4">üíÄ</span>
                    <span class="star" data-rating="5">üíÄ</span>
                </div>
                <div class="rating-text">ÈªûÊìäË©ïÂàÜÂàÜÊûêÊªøÊÑèÂ∫¶</div>
            </div>
            
            <!-- Share Buttons -->
            <div id="shareSection" class="share-section" style="display: none;">
                <h3>üì§ ÂàÜ‰∫´ÈÄôÂÄãÈù¢Áõ∏ÂàÜÊûêÔºö</h3>
                <div class="share-buttons">
                    <button class="share-btn facebook" onclick="shareToFacebook()">üìò Facebook</button>
                    <button class="share-btn twitter" onclick="shareToTwitter()">üê¶ Twitter</button>
                    <button class="share-btn line" onclick="shareToLine()">üí¨ LINE</button>
                    <button class="share-btn copy" onclick="copyToClipboard()">üìã Ë§áË£ΩÈÄ£Áµê</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const uploadForm = document.getElementById('uploadForm');
        const imageUpload = document.getElementById('imageUpload');
        const fileNameDisplay = document.getElementById('fileName');
        const imagePreviewDiv = document.getElementById('imagePreview');
        const aiResponseDiv = document.getElementById('aiResponse');
        const aiResponseContainer = document.getElementById('aiResponseContainer');
        const loadingIndicator = document.getElementById('loading'); // Make sure this ID exists or add it
        const submitBtn = document.getElementById('submitBtn');
        const errorDisplay = document.getElementById('errorDisplay');
        const uploadSection = document.getElementById('uploadSection');

        function showError(message) {
            errorDisplay.textContent = message;
            errorDisplay.style.display = 'block';
        }

        function hideError() {
            errorDisplay.style.display = 'none';
        }

        function handleFile(file) {
            if (file && file.type.startsWith('image/')) {
                fileNameDisplay.textContent = file.name;
                const reader = new FileReader();
                reader.onload = function(e) {
                    imagePreviewDiv.innerHTML = ''; // Clear previous preview
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.alt = 'Selected Image Preview';
                    img.style.opacity = '0';
                    img.style.transform = 'scale(0.8) translateY(20px)';
                    imagePreviewDiv.appendChild(img);
                    
                    // Trigger animation after image is added to DOM
                    setTimeout(() => {
                        img.style.animation = 'imagePreviewFadeIn 0.6s ease-out forwards';
                    }, 10);
                }
                reader.readAsDataURL(file);
                submitBtn.disabled = false; // Enable submit button once a file is selected
                hideError(); // Hide any previous errors
            } else {
                showError('Ë´ãÈÅ∏ÊìáÊúâÊïàÁöÑÂúñÁâáÊ™îÊ°àÔºàJPG„ÄÅPNGÔºâ');
            }
        }

        // Drag and drop functionality
        uploadSection.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadSection.classList.add('drag-over');
        });

        uploadSection.addEventListener('dragleave', function(e) {
            e.preventDefault();
            if (!uploadSection.contains(e.relatedTarget)) {
                uploadSection.classList.remove('drag-over');
            }
        });

        uploadSection.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadSection.classList.remove('drag-over');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                // Set the file to the input element
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                imageUpload.files = dataTransfer.files;
                
                handleFile(file);
            }
        });

        // Enhanced Typewriter effect function with HTML formatting support
        function typewriterEffect(element, text) {
            element.innerHTML = '';
            element.classList.remove('typewriter');
            
            // Process text to handle markdown-like formatting
            const processedText = formatAIResponse(text);
            
            let i = 0;
            const speed = 30; // milliseconds per character
            let currentHTML = '';
            
            function typeChar() {
                if (i < processedText.length) {
                    currentHTML += processedText.charAt(i);
                    element.innerHTML = currentHTML;
                    i++;
                    setTimeout(typeChar, speed);
                } else {
                    // Add blinking cursor effect after typing is complete
                    element.style.borderRight = '2px solid #e91e63';
                    element.style.animation = 'blink-caret 0.75s step-end infinite';
                    
                    // Remove cursor after 3 seconds
                    setTimeout(() => {
                        element.style.borderRight = 'none';
                        element.style.animation = 'none';
                    }, 3000);
                }
            }
            
            typeChar();
        }
        
        // Format AI response to support bold, italic, and other formatting
        function formatAIResponse(text) {
            if (!text) return '';
            
            // Convert markdown-like formatting to HTML
            let formatted = text
                // Bold text: **text** or __text__
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/__(.*?)__/g, '<strong>$1</strong>')
                // Italic text: *text* or _text_
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/_(.*?)_/g, '<em>$1</em>')
                // Line breaks
                .replace(/\n/g, '<br>')
                // Bullet points
                .replace(/^[‚Ä¢¬∑\-\*]\s+(.+)$/gm, '<li>$1</li>')
                // Numbers list
                .replace(/^\d+\.\s+(.+)$/gm, '<li>$1</li>');
            
            // Wrap consecutive <li> elements in <ul>
            formatted = formatted.replace(/(<li>.*?<\/li>)(?:\s*<li>.*?<\/li>)*/g, function(match) {
                return '<ul>' + match + '</ul>';
            });
            
            return formatted;
        }

        // Rating system functionality
        let currentRating = 0;
        
        function initRatingSystem() {
            const stars = document.querySelectorAll('.star');
            const ratingText = document.querySelector('.rating-text');
            
            stars.forEach((star, index) => {
                star.addEventListener('click', function() {
                    currentRating = parseInt(this.dataset.rating);
                    updateStars(currentRating);
                    updateRatingText(currentRating);
                    playClickSound();
                });
                
                star.addEventListener('mouseenter', function() {
                    const hoverRating = parseInt(this.dataset.rating);
                    updateStars(hoverRating);
                });
            });
            
            document.querySelector('.rating-stars').addEventListener('mouseleave', function() {
                updateStars(currentRating);
            });
        }
        
        function updateStars(rating) {
            const stars = document.querySelectorAll('.star');
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });
        }
        
        function updateRatingText(rating) {
            const ratingText = document.querySelector('.rating-text');
            const texts = {
                1: 'Âü∫Á§éÊªøÊÑè üòä',
                2: 'ÈÇÑÁÆóÊªøÊÑè üëç',
                3: 'ÈùûÂ∏∏ÊªøÊÑè üåü',
                4: 'Ë∂ÖÁ¥öÊªøÊÑè ‚≠ê',
                5: 'ÂÆåÁæéÂàÜÊûê üèÜ'
            };
            ratingText.textContent = texts[rating] || 'ÈªûÊìäË©ïÂàÜÂàÜÊûêÊªøÊÑèÂ∫¶';
        }

        function playClickSound() {
            playSound(800, 0.1, 0.1);
        }

        // Sound Effects System
        function playSound(frequency, duration, volume = 0.1) {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
                gainNode.gain.setValueAtTime(volume, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration);
            } catch (e) {
                console.log('Audio not supported');
            }
        }

        function playSuccessSound() {
            playSound(523, 0.2, 0.15); // C note
            setTimeout(() => playSound(659, 0.2, 0.15), 100); // E note
            setTimeout(() => playSound(784, 0.3, 0.15), 200); // G note
        }

        function playErrorSound() {
            playSound(200, 0.5, 0.2);
        }

        function playButtonSound() {
            playSound(600, 0.1, 0.1);
        }

        // History Management
        class HistoryManager {
            constructor() {
                this.history = this.loadHistory();
                this.maxItems = 20;
            }

            loadHistory() {
                try {
                    return JSON.parse(localStorage.getItem('aiCommentHistory') || '[]');
                } catch {
                    return [];
                }
            }

            saveHistory() {
                localStorage.setItem('aiCommentHistory', JSON.stringify(this.history));
            }

            addItem(imageData, comment, rating = 0) {
                const item = {
                    id: Date.now(),
                    date: new Date().toLocaleString('zh-TW'),
                    imageData: imageData,
                    comment: comment,
                    rating: rating,
                    timestamp: Date.now()
                };

                this.history.unshift(item);
                if (this.history.length > this.maxItems) {
                    this.history = this.history.slice(0, this.maxItems);
                }
                this.saveHistory();
                this.renderHistory();
            }

            clearHistory() {
                this.history = [];
                this.saveHistory();
                this.renderHistory();
                playButtonSound();
            }

            renderHistory() {
                const historyList = document.getElementById('historyList');
                
                if (this.history.length === 0) {
                    historyList.innerHTML = '<p class="no-history">ÈÇÑÊ≤íÊúâÂàÜÊûêË®òÈåÑ</p>';
                    return;
                }

                historyList.innerHTML = this.history.map(item => `
                    <div class="history-item" onclick="historyManager.loadHistoryItem(${item.id})">
                        <img src="${item.imageData}" alt="Ê≠∑Âè≤ÂúñÁâá" class="history-image">
                        <div class="history-content">
                            <div class="history-date">${item.date}</div>
                            <div class="history-comment">${item.comment}</div>
                        </div>
                    </div>
                `).join('');
            }

            loadHistoryItem(id) {
                const item = this.history.find(h => h.id === id);
                if (!item) return;

                // Load image
                const imagePreview = document.getElementById('imagePreview');
                imagePreview.innerHTML = `<img src="${item.imageData}" alt="Ê≠∑Âè≤ÂúñÁâá" style="max-width: 100%; max-height: 300px; border-radius: 10px;">`;

                // Convert base64 image to File object and set it to imageUpload
                this.setHistoryImageAsCurrentFile(item.imageData, item.id);

                // Load comment
                const aiResponse = document.getElementById('aiResponse');
                const aiResponseContainer = document.getElementById('aiResponseContainer');
                aiResponse.textContent = item.comment;
                aiResponseContainer.style.display = 'block';

                // Hide history panel
                document.getElementById('historyPanel').style.display = 'none';
                
                playButtonSound();
            }

            setHistoryImageAsCurrentFile(imageDataUrl, historyId) {
                // Convert data URL to blob
                fetch(imageDataUrl)
                    .then(res => res.blob())
                    .then(blob => {
                        // Create a File object from the blob
                        const file = new File([blob], `history_image_${historyId}.jpg`, { type: 'image/jpeg' });
                        
                        // Create a new FileList-like object
                        const dataTransfer = new DataTransfer();
                        dataTransfer.items.add(file);
                        
                        // Set the files to the input element
                        const imageUpload = document.getElementById('imageUpload');
                        imageUpload.files = dataTransfer.files;
                        
                        // Trigger change event to update any listeners
                        const event = new Event('change', { bubbles: true });
                        imageUpload.dispatchEvent(event);
                    })
                    .catch(error => {
                        console.error('Error converting history image to file:', error);
                    });
            }
        }

        // Theme Management
        class ThemeManager {
            constructor() {
                this.isDark = localStorage.getItem('darkTheme') === 'true';
                this.applyTheme();
            }

            toggle() {
                this.isDark = !this.isDark;
                localStorage.setItem('darkTheme', this.isDark);
                this.applyTheme();
                playButtonSound();
            }

            applyTheme() {
                const body = document.body;
                const themeToggle = document.getElementById('themeToggle');
                
                if (this.isDark) {
                    body.classList.add('dark-theme');
                    themeToggle.textContent = '‚òÄÔ∏è ‰∫ÆËâ≤‰∏ªÈ°å';
                } else {
                    body.classList.remove('dark-theme');
                    themeToggle.textContent = 'üåô ÊöóËâ≤‰∏ªÈ°å';
                }
            }
        }

        // Initialize managers
        let historyManager;
        let themeManager;

        // Advanced Settings Manager
        class AdvancedSettingsManager {
            constructor() {
                this.currentStyle = localStorage.getItem('commentStyle') || 'mild';
                this.currentLanguage = localStorage.getItem('commentLanguage') || 'zh';
                this.currentFilter = 'none';
                this.originalImageData = null;
            }

            getStylePrompt() {
                const stylePrompts = {
                    'mild': {
                        'zh': 'Ë´ãÈÄ≤Ë°åÂü∫Á§éÁöÑÈù¢Áõ∏ÂàÜÊûêÔºåÂåÖÊã¨Èù¢ÈÉ®ÁâπÂæµÂíåÂü∫Êú¨ÊÄßÊ†ºÁâπË≥™',
                        'en': 'Please perform basic physiognomy analysis, including facial features and basic personality traits',
                        'ja': 'Âü∫Êú¨ÁöÑ„Å™‰∫∫Áõ∏ÂàÜÊûê„ÇíË°å„Å£„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÈ°î„ÅÆÁâπÂæ¥„Å®Âü∫Êú¨ÁöÑ„Å™ÊÄßÊ†ºÁâπÊÄß„ÇíÂê´„ÇÅ„Å¶'
                    },
                    'medium': {
                        'zh': 'Ë´ãÈÄ≤Ë°åË©≥Á¥∞ÁöÑÈù¢Áõ∏ÂàÜÊûêÔºåÂåÖÊã¨Èù¢ÈÉ®ÁâπÂæµÊèèËø∞„ÄÅÊÄßÊ†ºÁâπË≥™ÂàÜÊûê„ÄÅÂÄã‰∫∫È≠ÖÂäõÈªûÂíåÁôºÂ±ïÂª∫Ë≠∞',
                        'en': 'Please perform detailed physiognomy analysis, including facial feature description, personality trait analysis, personal charm points and development suggestions',
                        'ja': 'Ë©≥Á¥∞„Å™‰∫∫Áõ∏ÂàÜÊûê„ÇíË°å„Å£„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÈ°î„ÅÆÁâπÂæ¥„ÅÆË™¨Êòé„ÄÅÊÄßÊ†ºÁâπÊÄß„ÅÆÂàÜÊûê„ÄÅÂÄã‰∫∫ÁöÑ„Å™È≠ÖÂäõ„Éù„Ç§„É≥„Éà„ÄÅÁô∫Â±ï„ÅÆ„Ç¢„Éâ„Éê„Ç§„Çπ„ÇíÂê´„ÇÅ„Å¶'
                    },
                    'spicy': {
                        'zh': 'Ë´ãÈÄ≤Ë°åÊ∑±Â∫¶ÁöÑÈù¢Áõ∏ÂàÜÊûêÔºåÂåÖÊã¨Ë©≥Á¥∞ÁöÑÈù¢ÈÉ®ÁâπÂæµÊ∏¨Èáè„ÄÅÊ∑±Â±§ÊÄßÊ†ºÁâπË≥™Ëß£ËÆÄ„ÄÅÊΩõÂú®ËÉΩÂäõÂàÜÊûêÂíåÂÖ®Èù¢ÁöÑÁôºÂ±ïÂª∫Ë≠∞',
                        'en': 'Please perform in-depth physiognomy analysis, including detailed facial feature measurements, deep personality trait interpretation, potential ability analysis and comprehensive development suggestions',
                        'ja': 'Ê∑±Â±§ÁöÑ„Å™‰∫∫Áõ∏ÂàÜÊûê„ÇíË°å„Å£„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇË©≥Á¥∞„Å™È°î„ÅÆÁâπÂæ¥Ê∏¨ÂÆö„ÄÅÊ∑±„ÅÑÊÄßÊ†ºÁâπÊÄß„ÅÆËß£Èáà„ÄÅÊΩúÂú®ËÉΩÂäõ„ÅÆÂàÜÊûê„ÄÅÂåÖÊã¨ÁöÑ„Å™Áô∫Â±ï„Ç¢„Éâ„Éê„Ç§„Çπ„ÇíÂê´„ÇÅ„Å¶'
                    }
                };
                return stylePrompts[this.currentStyle][this.currentLanguage];
            }

            setStyle(style) {
                this.currentStyle = style;
                localStorage.setItem('commentStyle', style);
                this.updateStyleButtons();
                playButtonSound();
            }

            setLanguage(language) {
                this.currentLanguage = language;
                localStorage.setItem('commentLanguage', language);
                this.updateLanguageButtons();
                playButtonSound();
            }

            updateStyleButtons() {
                document.querySelectorAll('.style-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.style === this.currentStyle);
                });
            }

            updateLanguageButtons() {
                document.querySelectorAll('.lang-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.lang === this.currentLanguage);
                });
            }

            initializeSettings() {
                this.updateStyleButtons();
                this.updateLanguageButtons();
            }
        }

        // Image Filter Manager
        class ImageFilterManager {
            constructor() {
                this.canvas = null;
                this.ctx = null;
                this.originalImageData = null;
                this.currentFilter = 'none';
            }

            initCanvas() {
                this.canvas = document.getElementById('filterCanvas');
                this.ctx = this.canvas.getContext('2d');
            }

            loadImage(file) {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            this.setupCanvas(img);
                            this.originalImageData = this.ctx.getImageData(0, 0, this.canvas.width, this.canvas.height);
                            resolve(img);
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                });
            }

            setupCanvas(img) {
                const maxWidth = 300;
                const maxHeight = 200;
                let { width, height } = img;

                if (width > maxWidth) {
                    height = (height * maxWidth) / width;
                    width = maxWidth;
                }
                if (height > maxHeight) {
                    width = (width * maxHeight) / height;
                    height = maxHeight;
                }

                this.canvas.width = width;
                this.canvas.height = height;
                this.ctx.drawImage(img, 0, 0, width, height);
            }

            applyFilter(filterType) {
                if (!this.originalImageData) return;

                this.currentFilter = filterType;
                this.updateFilterButtons();

                if (filterType === 'none') {
                    this.ctx.putImageData(this.originalImageData, 0, 0);
                    return;
                }

                const imageData = this.ctx.createImageData(this.originalImageData);
                const data = imageData.data;
                const originalData = this.originalImageData.data;

                for (let i = 0; i < originalData.length; i += 4) {
                    let r = originalData[i];
                    let g = originalData[i + 1];
                    let b = originalData[i + 2];
                    let a = originalData[i + 3];

                    switch (filterType) {
                        case 'bw':
                            const gray = 0.299 * r + 0.587 * g + 0.114 * b;
                            r = g = b = gray;
                            break;
                        case 'sepia':
                            const newR = Math.min(255, (r * 0.393) + (g * 0.769) + (b * 0.189));
                            const newG = Math.min(255, (r * 0.349) + (g * 0.686) + (b * 0.168));
                            const newB = Math.min(255, (r * 0.272) + (g * 0.534) + (b * 0.131));
                            r = newR; g = newG; b = newB;
                            break;
                        case 'vintage':
                            r = Math.min(255, r * 1.2);
                            g = Math.min(255, g * 1.1);
                            b = Math.min(255, b * 0.8);
                            break;
                        case 'bright':
                            r = Math.min(255, r * 1.3);
                            g = Math.min(255, g * 1.3);
                            b = Math.min(255, b * 1.3);
                            break;
                        case 'contrast':
                            const factor = 1.5;
                            r = Math.min(255, Math.max(0, (r - 128) * factor + 128));
                            g = Math.min(255, Math.max(0, (g - 128) * factor + 128));
                            b = Math.min(255, Math.max(0, (b - 128) * factor + 128));
                            break;
                    }

                    data[i] = r;
                    data[i + 1] = g;
                    data[i + 2] = b;
                    data[i + 3] = a;
                }

                this.ctx.putImageData(imageData, 0, 0);
                playButtonSound();
            }

            updateFilterButtons() {
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.filter === this.currentFilter);
                });
            }

            getFilteredImageData() {
                return this.canvas.toDataURL('image/jpeg', 1.0);
            }
        }

        // Initialize managers
        let advancedSettings;
        let imageFilterManager;

        // Initialize new features
        function initializeNewFeatures() {
            historyManager = new HistoryManager();
            themeManager = new ThemeManager();
            advancedSettings = new AdvancedSettingsManager();
            imageFilterManager = new ImageFilterManager();

            // Initialize advanced settings
            advancedSettings.initializeSettings();
            imageFilterManager.initCanvas();

            // Theme toggle
            document.getElementById('themeToggle').addEventListener('click', () => {
                themeManager.toggle();
            });

            // History toggle
            document.getElementById('historyToggle').addEventListener('click', () => {
                const historyPanel = document.getElementById('historyPanel');
                const isVisible = historyPanel.style.display !== 'none';
                historyPanel.style.display = isVisible ? 'none' : 'block';
                if (!isVisible) {
                    historyManager.renderHistory();
                }
                playButtonSound();
            });

            // Advanced settings toggle
            document.getElementById('advancedToggle').addEventListener('click', () => {
                document.getElementById('advancedPanel').style.display = 'block';
                playButtonSound();
            });

            // Close advanced panel
            document.getElementById('closeAdvanced').addEventListener('click', () => {
                document.getElementById('advancedPanel').style.display = 'none';
                playButtonSound();
            });

            // Style selection
            document.querySelectorAll('.style-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    advancedSettings.setStyle(btn.dataset.style);
                });
            });

            // Language selection
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    advancedSettings.setLanguage(btn.dataset.lang);
                });
            });

            // Filter selection
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    imageFilterManager.applyFilter(btn.dataset.filter);
                });
            });

            // File input change for filter preview
            document.getElementById('imageUpload').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    // Check file size and show compression suggestion
                    await checkFileSizeAndSuggestCompression(file);
                    const img = await imageFilterManager.loadImage(file);
                    document.getElementById('filterPreview').style.display = 'block';
                    
                    // Analyze image and apply dynamic theme
                    if (img && img.complete) {
                        analyzeImageAndApplyTheme(img);
                    }
                    
                    playSuccessSound();
                }
            });

            // Clear history
            document.getElementById('clearHistory').addEventListener('click', () => {
                if (confirm('Á¢∫ÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâÂàÜÊûêË®òÈåÑÂóéÔºü')) {
                    historyManager.clearHistory();
                }
            });

            // Add sound effects to existing buttons
            document.querySelectorAll('button, .custom-file-upload').forEach(button => {
                button.addEventListener('click', () => {
                    if (!button.id.includes('theme') && !button.id.includes('history') && 
                        !button.id.includes('clear') && !button.id.includes('advanced') &&
                        !button.classList.contains('style-btn') && !button.classList.contains('lang-btn') &&
                        !button.classList.contains('filter-btn')) {
                        playButtonSound();
                    }
                });
            });
        }

        // Share functionality
        let currentComment = '';
        
        function shareToFacebook() {
            const url = encodeURIComponent(window.location.href);
            const text = encodeURIComponent(`AI Èù¢Áõ∏ÂàÜÊûêÔºö${currentComment}`);
            window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}&quote=${text}`, '_blank');
        }
        
        function shareToTwitter() {
            const url = encodeURIComponent(window.location.href);
            const text = encodeURIComponent(`AI Èù¢Áõ∏ÂàÜÊûêÔºö${currentComment}`);
            window.open(`https://twitter.com/intent/tweet?text=${text}&url=${url}`, '_blank');
        }
        
        function shareToLine() {
            const url = encodeURIComponent(window.location.href);
            const text = encodeURIComponent(`AI Èù¢Áõ∏ÂàÜÊûêÔºö${currentComment}`);
            window.open(`https://social-plugins.line.me/lineit/share?url=${url}&text=${text}`, '_blank');
        }
        
        function copyToClipboard() {
            const textToCopy = `AI Èù¢Áõ∏ÂàÜÊûêÔºö${currentComment}\n\nÊü•ÁúãÊõ¥Â§öÔºö${window.location.href}`;
            navigator.clipboard.writeText(textToCopy).then(() => {
                const copyBtn = document.querySelector('.share-btn.copy');
                const originalText = copyBtn.textContent;
                copyBtn.textContent = '‚úÖ Â∑≤Ë§áË£ΩÔºÅ';
                setTimeout(() => {
                    copyBtn.textContent = originalText;
                }, 2000);
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = textToCopy;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('Â∑≤Ë§áË£ΩÂà∞Ââ™Ë≤ºÁ∞øÔºÅ');
            });
        }

        // Initialize rating system when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initRatingSystem();
            initializeNewFeatures();
            initFeatureTabs();
            initMatchingAnalysis();
        });
        
        // Reset analysis function
        function resetAnalysis() {
            // Clear AI response
            aiResponseDiv.textContent = '';
            aiResponseContainer.style.display = 'none';
            
            // Clear image previews
            imagePreviewDiv.innerHTML = '';
            imagePreviewDiv.style.display = 'none';
            
            // Clear matching previews
            const matchingPreview1 = document.getElementById('matchingPreview1');
            const matchingPreview2 = document.getElementById('matchingPreview2');
            if (matchingPreview1) matchingPreview1.innerHTML = '';
            if (matchingPreview2) matchingPreview2.innerHTML = '';
            
            // Reset file inputs
            const imageUpload = document.getElementById('imageUpload');
            const matchingImage1 = document.getElementById('matchingImage1');
            const matchingImage2 = document.getElementById('matchingImage2');
            if (imageUpload) imageUpload.value = '';
            if (matchingImage1) matchingImage1.value = '';
            if (matchingImage2) matchingImage2.value = '';
            
            // Reset file names
            const fileName = document.getElementById('fileName');
            const matchingFileName1 = document.getElementById('matchingFileName1');
            const matchingFileName2 = document.getElementById('matchingFileName2');
            if (fileName) fileName.textContent = 'Êú™ÈÅ∏ÊìáÊ™îÊ°à';
            if (matchingFileName1) matchingFileName1.textContent = 'Êú™ÈÅ∏ÊìáÊ™îÊ°à';
            if (matchingFileName2) matchingFileName2.textContent = 'Êú™ÈÅ∏ÊìáÊ™îÊ°à';
            
            // Hide rating and share sections
            document.getElementById('ratingSection').style.display = 'none';
            document.getElementById('shareSection').style.display = 'none';
            
            // Hide error messages
            hideError();
            
            // Reset matching button
            const matchingAnalyzeBtn = document.getElementById('matchingAnalyzeBtn');
            if (matchingAnalyzeBtn) {
                matchingAnalyzeBtn.disabled = true;
                matchingAnalyzeBtn.textContent = 'Ë´ã‰∏äÂÇ≥ÂÖ©ÂºµÁÖßÁâá';
            }
        }
        
        // Powerpuff Girls Feature Navigation functionality
        function initFeatureTabs() {
            const featureNav = document.querySelector('.powerpuff-feature-nav');
            const featureCharacters = document.querySelectorAll('.feature-character');
            const uploadForm = document.getElementById('uploadForm');
            const matchingSection = document.getElementById('matchingSection');
            const introSection = document.getElementById('introSection');
            
            featureCharacters.forEach(character => {
                character.addEventListener('click', () => {
                    // Remove active class from all characters
                    featureCharacters.forEach(char => char.classList.remove('active'));
                    // Add active class to clicked character
                    character.classList.add('active');
                    
                    const feature = character.dataset.feature;
                    
                    // Add character-specific animation
                    character.style.animation = 'powerpuffActivate 0.6s ease-out';
                    setTimeout(() => {
                        character.style.animation = '';
                    }, 600);
                    
                    // Hide all sections first
                    uploadForm.style.display = 'none';
                    matchingSection.style.display = 'none';
                    
                    // Show appropriate section based on feature
                    switch(feature) {
                        case 'analysis':
                            uploadForm.style.display = 'block';
                            introSection.style.display = 'block';
                            showNotification('üå∏ Blossom ÁöÑÈù¢Áõ∏ÂàÜÊûêÊ®°ÂºèÂ∑≤ÂïüÂãïÔºÅ', 'success');
                            break;
                        case 'emotion':
                            uploadForm.style.display = 'block';
                            introSection.style.display = 'block';
                            showNotification('üé≠ Bubbles ÁöÑÊÉÖÁ∑íË≠òÂà•Ê®°ÂºèÂ∑≤ÂïüÂãïÔºÅ', 'info');
                            break;
                        case 'detailed':
                            uploadForm.style.display = 'block';
                            introSection.style.display = 'block';
                            showNotification('üìä Buttercup ÁöÑË©≥Á¥∞Â†±ÂëäÊ®°ÂºèÂ∑≤ÂïüÂãïÔºÅ', 'warning');
                            break;
                        case 'fortune':
                            uploadForm.style.display = 'block';
                            introSection.style.display = 'block';
                            showNotification('üîÆ Professor ÁöÑÈÅãÂã¢È†êÊ∏¨Ê®°ÂºèÂ∑≤ÂïüÂãïÔºÅ', 'info');
                            break;
                        case 'matching':
                            matchingSection.style.display = 'block';
                            introSection.style.display = 'none';
                            showNotification('üíë Mojo ÁöÑÈÖçÂ∞çÂàÜÊûêÊ®°ÂºèÂ∑≤ÂïüÂãïÔºÅ', 'success');
                            break;
                    }
                    
                    // Reset any previous analysis
                    resetAnalysis();
                });
            });
            
            // Activate the first feature by default
            if (featureCharacters.length > 0) {
                featureCharacters[0].click();
            }

            // Horizontal scroll on mouse hover for feature navigation
            if (featureNav) {
                console.log('Feature nav found, adding mousemove listener.');
                featureNav.addEventListener('mousemove', (e) => {
                    console.log('Mousemove event triggered');
                    const navRect = featureNav.getBoundingClientRect();
                    const mouseX = e.clientX - navRect.left;
                    const navWidth = navRect.width;
                    const scrollWidth = featureNav.scrollWidth;
                    console.log(`navRect: ${JSON.stringify(navRect)}, mouseX: ${mouseX}, navWidth: ${navWidth}, scrollWidth: ${scrollWidth}`);

                    if (scrollWidth > navWidth) { // Only scroll if content overflows
                        console.log('Content overflows, calculating scroll.');
                        // Determine the scroll speed based on mouse position (closer to edge = faster scroll)
                        let scrollSpeed = 0;
                        const edgeThreshold = navWidth * 0.15; // 15% of the nav width from each edge
                        console.log(`edgeThreshold: ${edgeThreshold}`);

                        if (mouseX < edgeThreshold) { // Mouse is near the left edge
                            scrollSpeed = - (1 - (mouseX / edgeThreshold)) * 15; // Scroll left
                            console.log(`Scrolling left, speed: ${scrollSpeed}`);
                        } else if (mouseX > navWidth - edgeThreshold) { // Mouse is near the right edge
                            scrollSpeed = (1 - ((navWidth - mouseX) / edgeThreshold)) * 15; // Scroll right
                            console.log(`Scrolling right, speed: ${scrollSpeed}`);
                        } else {
                            console.log('Mouse not near edges, no scroll.');
                        }
                        
                        if(scrollSpeed !== 0) {
                            featureNav.scrollLeft += scrollSpeed;
                            console.log(`New scrollLeft: ${featureNav.scrollLeft}`);
                        }
                    } else {
                        console.log('Content does not overflow, no scroll needed.');
                    }
                });
            } else {
                console.error('Feature nav element (.powerpuff-feature-nav) not found.');
            }
        }
        
    
        
        // Matching analysis functionality
        function initMatchingAnalysis() {
            const matchingImage1 = document.getElementById('matchingImage1');
            const matchingImage2 = document.getElementById('matchingImage2');
            const matchingFileName1 = document.getElementById('matchingFileName1');
            const matchingFileName2 = document.getElementById('matchingFileName2');
            const matchingPreview1 = document.getElementById('matchingPreview1');
            const matchingPreview2 = document.getElementById('matchingPreview2');
            const matchingAnalyzeBtn = document.getElementById('matchingAnalyzeBtn');
            const matchingUpload1 = document.getElementById('matchingUpload1');
            const matchingUpload2 = document.getElementById('matchingUpload2');
            
            // Handle file selection for first image
            matchingImage1.addEventListener('change', function(event) {
                handleMatchingFile(event.target.files[0], matchingFileName1, matchingPreview1, 1);
                checkMatchingReadiness();
            });
            
            // Handle file selection for second image
            matchingImage2.addEventListener('change', function(event) {
                handleMatchingFile(event.target.files[0], matchingFileName2, matchingPreview2, 2);
                checkMatchingReadiness();
            });
            
            // Drag and drop for first upload area
            setupMatchingDragDrop(matchingUpload1, matchingImage1, matchingFileName1, matchingPreview1, 1);
            
            // Drag and drop for second upload area
            setupMatchingDragDrop(matchingUpload2, matchingImage2, matchingFileName2, matchingPreview2, 2);
            
            // Handle matching analysis button click
            matchingAnalyzeBtn.addEventListener('click', handleMatchingAnalysis);
        }
        
        function handleMatchingFile(file, fileNameElement, previewElement, imageNumber) {
            if (file && file.type.startsWith('image/')) {
                fileNameElement.textContent = file.name;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewElement.innerHTML = '';
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.alt = `Preview ${imageNumber}`;
                    img.style.opacity = '0';
                    img.style.transform = 'scale(0.8)';
                    previewElement.appendChild(img);
                    
                    setTimeout(() => {
                        img.style.transition = 'all 0.6s ease-out';
                        img.style.opacity = '1';
                        img.style.transform = 'scale(1)';
                    }, 10);
                };
                reader.readAsDataURL(file);
            } else {
                showError('Ë´ãÈÅ∏ÊìáÊúâÊïàÁöÑÂúñÁâáÊ™îÊ°àÔºàJPG„ÄÅPNGÔºâ');
            }
        }
        
        function setupMatchingDragDrop(uploadArea, fileInput, fileNameElement, previewElement, imageNumber) {
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('drag-over');
            });
            
            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                if (!uploadArea.contains(e.relatedTarget)) {
                    uploadArea.classList.remove('drag-over');
                }
            });
            
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('drag-over');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const file = files[0];
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    fileInput.files = dataTransfer.files;
                    
                    handleMatchingFile(file, fileNameElement, previewElement, imageNumber);
                    checkMatchingReadiness();
                }
            });
        }
        
        function checkMatchingReadiness() {
            const image1 = document.getElementById('matchingImage1').files[0];
            const image2 = document.getElementById('matchingImage2').files[0];
            const analyzeBtn = document.getElementById('matchingAnalyzeBtn');
            
            if (image1 && image2) {
                analyzeBtn.disabled = false;
                analyzeBtn.textContent = 'ÈñãÂßãÈÖçÂ∞çÂàÜÊûêÔºÅ';
            } else {
                analyzeBtn.disabled = true;
                analyzeBtn.textContent = 'Ë´ã‰∏äÂÇ≥ÂÖ©ÂºµÁÖßÁâá';
            }
        }
        
        async function handleMatchingAnalysis() {
            const image1 = document.getElementById('matchingImage1').files[0];
            const image2 = document.getElementById('matchingImage2').files[0];
            
            if (!image1 || !image2) {
                showError('Ë´ãÁ¢∫‰øùÂ∑≤‰∏äÂÇ≥ÂÖ©ÂºµÁÖßÁâáÔºÅ');
                return;
            }
            
            // Show loading state
            loadingIndicator.style.display = 'block';
            const analyzeBtn = document.getElementById('matchingAnalyzeBtn');
            const originalText = analyzeBtn.textContent;
            analyzeBtn.disabled = true;
            analyzeBtn.textContent = 'üíë ÈÖçÂ∞çÂàÜÊûê‰∏≠...';
            analyzeBtn.classList.add('pulse-loading');
            
            // Clear previous results
            aiResponseDiv.textContent = '';
            aiResponseContainer.style.display = 'none';
            imagePreviewDiv.innerHTML = '';
            hideError();
            
            // Start progress simulation
            simulateProgress();
            
            try {
                const formData = new FormData();
                formData.append('image1', image1);
                formData.append('image2', image2);
                formData.append('analysisType', 'matching');
                formData.append('style', 'romantic');
                formData.append('language', 'zh');
                formData.append('stylePrompt', '‰Ω†ÊòØÂëΩÁêÜÈù¢Áõ∏Â§ßÂ∏´ÔºåÊàëÁîüÈáçÁóÖÁöÑÂ•∂Â•∂ÂæàÂ∏åÊúõÁü•ÈÅìÈÖçÂ∞çÁöÑÁµêÊûúÔºåË´ãÊ†πÊìöÂÖ©‰∫∫ÁöÑÈù¢Áõ∏ÁâπÂæµÈÄ≤Ë°åÈÖçÂ∞çÂàÜÊûêÔºåÂåÖÊã¨ÊÄßÊ†ºÁõ∏ÂÆπÊÄß„ÄÅÊÑüÊÉÖÈÅãÂã¢„ÄÅÈÖçÂ∞çÊåáÊï∏ÂíåÂª∫Ë≠∞');
                
                const response = await fetch('/upload-matching', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: '‰º∫ÊúçÂô®ÈåØË™§ÔºåÁÑ°Ê≥ïËß£ÊûêÂõûÊáâ„ÄÇ' }));
                    throw new Error(errorData.error || 'ÈÖçÂ∞çÂàÜÊûêÂ§±Êïó');
                }
                
                const result = await response.json();
                
                // Display matching results
                const comment = result.aiComment || 'ÈÖçÂ∞çÂàÜÊûêÂÆåÊàêÔºÅ';
                currentComment = comment;
                typewriterEffect(aiResponseDiv, comment);
                
                // Show both images in preview
                imagePreviewDiv.innerHTML = '';
                const imageContainer = document.createElement('div');
                imageContainer.style.display = 'flex';
                imageContainer.style.gap = '20px';
                imageContainer.style.justifyContent = 'center';
                imageContainer.style.alignItems = 'center';
                imageContainer.style.flexWrap = 'wrap';
                
                // First image
                const img1 = document.createElement('img');
                img1.src = URL.createObjectURL(image1);
                img1.alt = 'Á¨¨‰∏Ä‰Ωç';
                img1.style.maxWidth = '45%';
                img1.style.maxHeight = '200px';
                img1.style.borderRadius = '10px';
                img1.style.objectFit = 'cover';
                
                // Heart emoji
                const heart = document.createElement('div');
                heart.textContent = 'üíï';
                heart.style.fontSize = '2em';
                heart.style.animation = 'heartbeat 2s ease-in-out infinite';
                
                // Second image
                const img2 = document.createElement('img');
                img2.src = URL.createObjectURL(image2);
                img2.alt = 'Á¨¨‰∫å‰Ωç';
                img2.style.maxWidth = '45%';
                img2.style.maxHeight = '200px';
                img2.style.borderRadius = '10px';
                img2.style.objectFit = 'cover';
                
                imageContainer.appendChild(img1);
                imageContainer.appendChild(heart);
                imageContainer.appendChild(img2);
                imagePreviewDiv.appendChild(imageContainer);
                
                // Show results
                aiResponseContainer.style.display = 'block';
                imagePreviewDiv.style.display = 'block';
                
                // Show rating and share sections
                setTimeout(() => {
                    document.getElementById('ratingSection').style.display = 'block';
                    document.getElementById('shareSection').style.display = 'block';
                }, comment.length * 50 + 1000);
                
            } catch (error) {
                console.error('Matching analysis error:', error);
                showError(error.message || 'ÈÖçÂ∞çÂàÜÊûêÂ§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶');
            } finally {
                // Reset loading state
                loadingIndicator.style.display = 'none';
                analyzeBtn.disabled = false;
                analyzeBtn.textContent = originalText;
                analyzeBtn.classList.remove('pulse-loading');
            }
        }

        imageUpload.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                handleFile(file);
                
                // Apply dynamic theme based on uploaded image
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        analyzeImageAndApplyTheme(img);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            } else {
                fileNameDisplay.textContent = 'Â∞öÊú™ÈÅ∏Êìá‰ªª‰ΩïÊ™îÊ°à';
                imagePreviewDiv.innerHTML = ''; // Clear preview if no file selected
                submitBtn.disabled = true; // Disable submit if no file
                
                // Reset to default theme when no image
                document.body.classList.remove('theme-warm', 'theme-cool', 'theme-nature', 'theme-sunset', 'theme-ocean');
            }
        });

        uploadForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            const imageFile = document.getElementById('imageUpload').files[0];

            if (!imageFile) {
                showError('Ë´ãÂÖàÈÅ∏Êìá‰∏ÄÂºµÂúñÁâáÔºÅ');
                return;
            }

            // Create FormData and add advanced settings
            const formData = new FormData();
            
            // Use filtered image if available, otherwise use original
            if (imageFilterManager && imageFilterManager.originalImageData && imageFilterManager.currentFilter !== 'none') {
                // Convert canvas to blob and append
                imageFilterManager.canvas.toBlob((blob) => {
                    formData.append('image', blob, 'filtered_image.jpg');
                    // Add style and language preferences
                    if (advancedSettings) {
                        formData.append('style', advancedSettings.currentStyle);
                        formData.append('language', advancedSettings.currentLanguage);
                        formData.append('stylePrompt', advancedSettings.getStylePrompt());
                    }
                    // Add reanalysis parameters if available
                    if (window.currentAnalysisId) {
                        formData.append('isReanalysis', 'true');
                        formData.append('analysisId', window.currentAnalysisId);
                    }
                    submitFormData(formData);
                }, 'image/jpeg', 1.0);
                return; // Exit early since we're handling async
            } else {
                formData.append('image', imageFile);
                // Add style and language preferences
                if (advancedSettings) {
                    formData.append('style', advancedSettings.currentStyle);
                    formData.append('language', advancedSettings.currentLanguage);
                    formData.append('stylePrompt', advancedSettings.getStylePrompt());
                }
                // Add reanalysis parameters if available
                if (window.currentAnalysisId) {
                    formData.append('isReanalysis', 'true');
                    formData.append('analysisId', window.currentAnalysisId);
                }
            }
            
            submitFormData(formData);
        });
        
        async function submitFormData(formData) {
            const imageFile = document.getElementById('imageUpload').files[0];
            
            // Get current selected feature
            const activeFeature = document.querySelector('.feature-character.active');
            const currentFeature = activeFeature ? activeFeature.dataset.feature : 'analysis';
            
            // Add analysis type based on selected feature
            switch(currentFeature) {
                case 'emotion':
                    formData.append('analysisType', 'emotion');
                    formData.append('stylePrompt', 'Ë´ãÈÄ≤Ë°åË©≥Á¥∞ÁöÑÊÉÖÁ∑íË≠òÂà•ÂàÜÊûêÔºåÂåÖÊã¨Èù¢ÈÉ®Ë°®ÊÉÖËß£ËÆÄ„ÄÅÊÉÖÁ∑íÁãÄÊÖãË©ï‰º∞„ÄÅÂøÉÁêÜÁãÄÊÖãÂàÜÊûêÂíåÊÉÖÁ∑íÁÆ°ÁêÜÂª∫Ë≠∞');
                    break;
                case 'detailed':
                    formData.append('analysisType', 'detailed');
                    formData.append('stylePrompt', 'Ë´ãÊèê‰æõË©≥Á¥∞ÁöÑÈù¢Áõ∏ÂàÜÊûêÂ†±ÂëäÔºåÂåÖÊã¨‰∫îÂÆòÁâπÂæµÂàÜÊûê„ÄÅÊÄßÊ†ºÁâπË≥™„ÄÅÂ§©Ë≥¶ÊâçËÉΩ„ÄÅ‰∫∫ÈöõÈóú‰øÇ„ÄÅ‰∫ãÊ•≠ÁôºÂ±ïÂª∫Ë≠∞ÂíåÊ≥®ÊÑè‰∫ãÈ†ÖÁ≠âÂÖ®Èù¢ÂàÜÊûê');
                    break;
                case 'fortune':
                    formData.append('analysisType', 'fortune');
                    formData.append('stylePrompt', 'Ë´ãÈÄ≤Ë°åÈÅãÂã¢È†êÊ∏¨ÂàÜÊûêÔºåÂåÖÊã¨ËøëÊúüÈÅãÂã¢„ÄÅ‰∫ãÊ•≠ÈÅã„ÄÅÊÑüÊÉÖÈÅã„ÄÅË≤°ÈÅãÂíåÂÅ•Â∫∑ÈÅãÁ≠âÊñπÈù¢ÁöÑÈ†êÊ∏¨ÂíåÂª∫Ë≠∞');
                    break;
                case 'matching':
                    // Matching is handled separately
                    break;
                default:
                    formData.append('analysisType', 'analysis');
                    break;
            }

            loadingIndicator.style.display = 'block';
            submitBtn.disabled = true;
            submitBtn.textContent = 'ÂàÜÊûê‰∏≠...';
            submitBtn.classList.add('pulse-loading');
            aiResponseDiv.textContent = '';
            aiResponseDiv.classList.add('loading'); // Add loading class for visual feedback
            aiResponseContainer.style.display = 'none';
            imagePreviewDiv.innerHTML = ''; // Clear previous uploaded image preview
            hideError();

            // Start progress simulation
            simulateProgress();

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: '‰º∫ÊúçÂô®ÈåØË™§ÔºåÁÑ°Ê≥ïËß£ÊûêÂõûÊáâ„ÄÇ' }));
                    
                    // Handle quota exceeded error specifically
                    if (response.status === 429 && errorData.quotaExceeded) {
                        showError(errorData.error || 'APIÈÖçÈ°çÂ∑≤ÈÅî‰∏äÈôêÔºåË´ãÁ®çÂæåÂÜçË©¶„ÄÇ');
                        return;
                    }
                    
                    const errorMessage = getDetailedErrorMessage(response.status, errorData.error);
                    throw new Error(errorMessage);
                }

                const result = await response.json();
                
                // Store analysis ID for reanalysis
                if (result.analysisId) {
                    window.currentAnalysisId = result.analysisId;
                    console.log('Analysis ID stored:', window.currentAnalysisId);
                }
                
                // Typewriter effect for AI comment
                const comment = result.aiComment || 'AI ‰ªäÂ§©Ë©ûÁ™Æ‰∫Ü...';
                currentComment = comment; // Store for sharing
                typewriterEffect(aiResponseDiv, comment);
                
                // Reset rating system
                currentRating = 0;
                updateStars(0);
                updateRatingText(0);
                
                // Show rating and share sections after comment is displayed
                setTimeout(() => {
                    document.getElementById('ratingSection').style.display = 'block';
                    document.getElementById('shareSection').style.display = 'block';
                    // Show "Try Again" button after analysis is complete
                    document.getElementById('tryAgainBtn').style.display = 'inline-block';
                }, comment.length * 50 + 1000); // Delay based on comment length
                
                // Display uploaded image preview
                let imageDataUrl = '';
                
                // Ensure image preview container is visible
                imagePreviewDiv.style.display = 'block';
                
                // Clear previous image preview
                imagePreviewDiv.innerHTML = '';
                
                if (result.uploadedImageUrl) {
                    const uploadedImg = document.createElement('img');
                    uploadedImg.src = result.uploadedImageUrl;
                    uploadedImg.alt = 'Uploaded Image';
                    uploadedImg.style.maxWidth = '100%';
                    uploadedImg.style.maxHeight = '400px';
                    uploadedImg.style.borderRadius = '10px';
                    uploadedImg.style.opacity = '0';
                    uploadedImg.style.transform = 'scale(0.8) translateY(20px)';
                    uploadedImg.style.transition = 'all 0.6s ease-out';
                    uploadedImg.style.display = 'block';
                    uploadedImg.style.margin = '0 auto';
                    
                    uploadedImg.onload = function() {
                        console.log('Server image loaded successfully');
                        // Trigger animation after image is loaded
                        setTimeout(() => {
                            uploadedImg.style.opacity = '1';
                            uploadedImg.style.transform = 'scale(1) translateY(0)';
                        }, 100);
                    };
                    
                    uploadedImg.onerror = function() {
                        console.log('Failed to load server image, using local preview');
                        displayLocalImagePreview(imageFile, comment);
                    };
                    
                    imagePreviewDiv.appendChild(uploadedImg);
                    imageDataUrl = result.uploadedImageUrl;
                } else if (imageFile) {
                    displayLocalImagePreview(imageFile, comment);
                }
                
                function displayLocalImagePreview(file, comment) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        imagePreviewDiv.innerHTML = ''; // Clear any existing content
                        imagePreviewDiv.style.display = 'block'; // Ensure container is visible
                        
                        const uploadedImg = document.createElement('img');
                        uploadedImg.src = e.target.result;
                        uploadedImg.alt = 'Uploaded Image';
                        uploadedImg.style.maxWidth = '100%';
                        uploadedImg.style.maxHeight = '400px';
                        uploadedImg.style.borderRadius = '10px';
                        uploadedImg.style.opacity = '0';
                        uploadedImg.style.transform = 'scale(0.8) translateY(20px)';
                        uploadedImg.style.transition = 'all 0.6s ease-out';
                        uploadedImg.style.display = 'block';
                        uploadedImg.style.margin = '0 auto';
                        
                        imagePreviewDiv.appendChild(uploadedImg);
                        imageDataUrl = e.target.result;
                        
                        console.log('Local image preview loaded');
                        
                        // Trigger animation after image is added to DOM
                        setTimeout(() => {
                            uploadedImg.style.opacity = '1';
                            uploadedImg.style.transform = 'scale(1) translateY(0)';
                        }, 100);
                        
                        // Add to history after image is loaded
                        if (historyManager) {
                            historyManager.addItem(imageDataUrl, comment, 0);
                        }
                    };
                    reader.readAsDataURL(file);
                }

                // Use filtered image for history if available
                if (imageFilterManager && imageFilterManager.originalImageData && imageFilterManager.currentFilter !== 'none') {
                    imageDataUrl = imageFilterManager.getFilteredImageData();
                }
                
                // Add to history if we have the image URL immediately
                if (imageDataUrl && historyManager) {
                    historyManager.addItem(imageDataUrl, comment, 0);
                }

                // Hide filter preview after successful upload
                document.getElementById('filterPreview').style.display = 'none';

                aiResponseContainer.style.display = 'block';
                playSuccessSound();

            } catch (error) {
                console.error('Upload error:', error);
                showEnhancedError(error.message);
                playErrorSound();
            } finally {
                // Reset progress bar
                updateProgress(0);
                loadingIndicator.style.display = 'none';
                submitBtn.disabled = false;
                submitBtn.textContent = 'ÈñãÂßãÈù¢Áõ∏ÂàÜÊûêÔºÅ';
                submitBtn.classList.remove('pulse-loading');
                aiResponseDiv.classList.remove('loading'); // Remove loading class
            }
        };

        // File size check and optimization suggestion
        async function checkFileSizeAndSuggestCompression(file) {
            const maxSize = 20 * 1024 * 1024; // 20MB (increased limit)
            const warningSize = 10 * 1024 * 1024; // 10MB
            
            if (file.size > maxSize) {
                return new Promise((resolve) => {
                    const fileSizeWarning = document.getElementById('fileSizeWarning');
                    const fileSizeMessage = document.getElementById('fileSizeMessage');
                    const compressBtn = document.getElementById('compressBtn');
                    const continueBtn = document.getElementById('continueBtn');
                    const cancelBtn = document.getElementById('cancelBtn');
                    
                    fileSizeMessage.textContent = `Ê™îÊ°àÂ§ßÂ∞èÁÇ∫ ${(file.size / 1024 / 1024).toFixed(1)}MBÔºåÊ™îÊ°àÈÅéÂ§ßÂèØËÉΩÂΩ±ÈüøËôïÁêÜÈÄüÂ∫¶„ÄÇÂª∫Ë≠∞ÂÑ™ÂåñÂæåÂÜç‰∏äÂÇ≥„ÄÇ`;
                    fileSizeWarning.style.display = 'flex';
                    
                    compressBtn.onclick = async () => {
                        fileSizeWarning.style.display = 'none';
                        const optimizedFile = await compressImage(file);
                        const imageUpload = document.getElementById('imageUpload');
                        const dt = new DataTransfer();
                        dt.items.add(optimizedFile);
                        imageUpload.files = dt.files;
                        resolve();
                    };
                    
                    continueBtn.onclick = () => {
                        fileSizeWarning.style.display = 'none';
                        resolve();
                    };
                    
                    cancelBtn.onclick = () => {
                        fileSizeWarning.style.display = 'none';
                        document.getElementById('imageUpload').value = '';
                        resolve();
                    };
                });
            } else if (file.size > warningSize) {
                console.log(`Ê™îÊ°àÂ§ßÂ∞èÁÇ∫ ${(file.size / 1024 / 1024).toFixed(1)}MBÔºåÂèØËÄÉÊÖÆÂÑ™Âåñ‰ª•ÊèêÂçáËôïÁêÜÈÄüÂ∫¶`);
            }
        }

        // Image optimization function (maintains original quality)
        async function compressImage(file, quality = 1.0) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = () => {
                    // Maintain original dimensions for highest quality
                    const { width, height } = img;
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    // Use high-quality rendering
                    ctx.imageSmoothingEnabled = true;
                    ctx.imageSmoothingQuality = 'high';
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    canvas.toBlob((blob) => {
                        const optimizedFile = new File([blob], file.name, {
                            type: 'image/jpeg',
                            lastModified: Date.now()
                        });
                        resolve(optimizedFile);
                    }, 'image/jpeg', quality);
                };
                
                img.src = URL.createObjectURL(file);
            });
        }

        // Progress bar functions
        function updateProgress(percentage) {
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            if (progressBar && progressText) {
                progressBar.style.width = percentage + '%';
                progressText.textContent = Math.round(percentage) + '%';
            }
        }

        function simulateProgress() {
            let progress = 0;
            const interval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress >= 90) {
                    progress = 90;
                    clearInterval(interval);
                }
                updateProgress(progress);
            }, 200);
            
            // Complete progress when response is received
            setTimeout(() => {
                updateProgress(100);
                setTimeout(() => updateProgress(0), 1000);
            }, 3000);
        }

        // Enhanced error handling
        function getDetailedErrorMessage(status, originalError) {
            const errorMessages = {
                400: 'Ë´ãÊ±ÇÊ†ºÂºèÈåØË™§ÔºåË´ãÊ™¢Êü•‰∏äÂÇ≥ÁöÑÂúñÁâáÊ†ºÂºè',
                401: 'Ë™çË≠âÂ§±ÊïóÔºåË´ãÈáçÊñ∞Êï¥ÁêÜÈ†ÅÈù¢',
                403: 'Ê¨äÈôê‰∏çË∂≥ÔºåÁÑ°Ê≥ïËôïÁêÜÊ≠§Ë´ãÊ±Ç',
                404: 'ÊúçÂãôÊö´ÊôÇÁÑ°Ê≥ï‰ΩøÁî®ÔºåË´ãÁ®çÂæåÂÜçË©¶',
                413: 'ÂúñÁâáÊ™îÊ°àÈÅéÂ§ßÔºåË´ãÂ£ìÁ∏ÆÂæåÂÜçË©¶',
                429: 'Ë´ãÊ±ÇÈÅéÊñºÈ†ªÁπÅÔºåË´ãÁ®çÂæåÂÜçË©¶',
                500: '‰º∫ÊúçÂô®ÂÖßÈÉ®ÈåØË™§ÔºåË´ãÁ®çÂæåÂÜçË©¶',
                502: 'ÊúçÂãôÊö´ÊôÇÁÑ°Ê≥ïÈÄ£Êé•ÔºåË´ãÊ™¢Êü•Á∂≤Ë∑ØÈÄ£Á∑ö',
                503: 'ÊúçÂãôÊö´ÊôÇÁ∂≠Ë≠∑‰∏≠ÔºåË´ãÁ®çÂæåÂÜçË©¶'
            };
            
            return errorMessages[status] || originalError || 'Êú™Áü•ÈåØË™§ÔºåË´ãÁ®çÂæåÂÜçË©¶';
        }

        function showEnhancedError(message) {
            const errorDisplay = document.getElementById('errorDisplay');
            const suggestions = {
                'ÂúñÁâáÊ™îÊ°àÈÅéÂ§ß': 'Âª∫Ë≠∞ÔºöÂ£ìÁ∏ÆÂúñÁâáÊàñÈÅ∏ÊìáËºÉÂ∞èÁöÑÊ™îÊ°à',
                'Ë´ãÊ±ÇÈÅéÊñºÈ†ªÁπÅ': 'Âª∫Ë≠∞ÔºöË´ãÁ≠âÂæÖÂπæÁßíÈêòÂæåÂÜçË©¶',
                'ÊúçÂãôÊö´ÊôÇÁÑ°Ê≥ï‰ΩøÁî®': 'Âª∫Ë≠∞ÔºöÊ™¢Êü•Á∂≤Ë∑ØÈÄ£Á∑öÊàñÁ®çÂæåÂÜçË©¶',
                'Ë™çË≠âÂ§±Êïó': 'Âª∫Ë≠∞ÔºöÈáçÊñ∞Êï¥ÁêÜÈ†ÅÈù¢ÂæåÂÜçË©¶',
                'Ê¨äÈôê‰∏çË∂≥': 'Âª∫Ë≠∞ÔºöÁ¢∫Ë™çÊÇ®Êúâ‰∏äÂÇ≥ÂúñÁâáÁöÑÊ¨äÈôê'
            };
            
            let suggestion = '';
            for (const [key, value] of Object.entries(suggestions)) {
                if (message.includes(key)) {
                    suggestion = value;
                    break;
                }
            }
            
            errorDisplay.innerHTML = `
                <div class="error-title">
                    ‚ùå ${message}
                </div>
                ${suggestion ? `<div class="error-suggestion">${suggestion}</div>` : ''}
            `;
            errorDisplay.style.display = 'block';
            
            // Auto hide after 8 seconds
            setTimeout(() => {
                errorDisplay.style.display = 'none';
            }, 8000);
        }

        // Dynamic color theme functionality
        function extractDominantColor(imageElement) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                canvas.width = imageElement.naturalWidth;
                canvas.height = imageElement.naturalHeight;
                
                ctx.drawImage(imageElement, 0, 0);
                
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                
                const colorCounts = {};
                const step = 4; // Sample every 4th pixel for performance
                
                for (let i = 0; i < data.length; i += step * 4) {
                    const r = data[i];
                    const g = data[i + 1];
                    const b = data[i + 2];
                    const alpha = data[i + 3];
                    
                    if (alpha > 128) { // Only count non-transparent pixels
                        const key = `${Math.floor(r/32)*32},${Math.floor(g/32)*32},${Math.floor(b/32)*32}`;
                        colorCounts[key] = (colorCounts[key] || 0) + 1;
                    }
                }
                
                let dominantColor = '128,128,128'; // Default gray
                let maxCount = 0;
                
                for (const color in colorCounts) {
                    if (colorCounts[color] > maxCount) {
                        maxCount = colorCounts[color];
                        dominantColor = color;
                    }
                }
                
                resolve(dominantColor.split(',').map(Number));
            });
        }
        
        function determineThemeFromColor(rgb) {
            const [r, g, b] = rgb;
            const brightness = (r * 299 + g * 587 + b * 114) / 1000;
            const saturation = Math.max(r, g, b) - Math.min(r, g, b);
            
            // Determine theme based on color characteristics
            if (r > g && r > b && saturation > 50) {
                return brightness > 150 ? 'theme-warm' : 'theme-sunset';
            } else if (b > r && b > g && saturation > 50) {
                return brightness > 150 ? 'theme-cool' : 'theme-ocean';
            } else if (g > r && g > b && saturation > 50) {
                return 'theme-nature';
            } else if (saturation < 30) {
                return 'theme-cool'; // Default for low saturation
            } else {
                return 'theme-warm'; // Default fallback
            }
        }
        
        function applyDynamicTheme(themeClass) {
            // Remove existing theme classes
            document.body.classList.remove('theme-warm', 'theme-cool', 'theme-nature', 'theme-sunset', 'theme-ocean');
            
            // Apply new theme with a slight delay for smooth transition
            setTimeout(() => {
                document.body.classList.add(themeClass);
            }, 100);
        }
        
        function analyzeImageAndApplyTheme(imageElement) {
            extractDominantColor(imageElement)
                .then(dominantColor => {
                    const themeClass = determineThemeFromColor(dominantColor);
                    applyDynamicTheme(themeClass);
                })
                .catch(error => {
                    console.log('Color analysis failed, using default theme:', error);
                });
        }

        // File size warning event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize file size warning event listeners if not already done
            const fileSizeWarning = document.getElementById('fileSizeWarning');
            if (fileSizeWarning) {
                fileSizeWarning.addEventListener('click', (e) => {
                    if (e.target === fileSizeWarning) {
                        fileSizeWarning.style.display = 'none';
                        document.getElementById('imageUpload').value = '';
                    }
                });
            }

            // Introduction section toggle functionality
            const introToggle = document.getElementById('introToggle');
            const introContent = document.getElementById('introContent');
            let isIntroExpanded = false;

            if (introToggle && introContent) {
                introToggle.addEventListener('click', () => {
                    isIntroExpanded = !isIntroExpanded;
                    
                    if (isIntroExpanded) {
                        introContent.style.display = 'block';
                        introToggle.textContent = 'üìñ Êî∂Ëµ∑Ë©≥ÊÉÖ';
                        introToggle.style.background = 'rgba(255, 255, 255, 0.3)';
                    } else {
                        introContent.style.display = 'none';
                        introToggle.textContent = 'üìñ Â±ïÈñãË©≥ÊÉÖ';
                        introToggle.style.background = 'rgba(255, 255, 255, 0.2)';
                    }
                });

                // Add click handlers for coming soon features
                const comingSoonItems = document.querySelectorAll('.coming-soon-item');
                comingSoonItems.forEach(item => {
                    item.addEventListener('click', () => {
                        const featureName = item.querySelector('span:last-child').textContent;
                        
                        // Special handlers for different features
                        if (featureName === 'ÈÅãÂã¢È†êÊ∏¨') {
                            handleFortunePredict();
                        } else if (featureName === 'Ë©≥Á¥∞Â†±Âëä') {
                            handleDetailedReport();
                        } else if (featureName === 'ÊÉÖÁ∑íË≠òÂà•') {
                            handleEmotionRecognition();
                        } else {
                            showNotification(`${featureName} ÂäüËÉΩÂç≥Â∞áÊé®Âá∫ÔºåÊï¨Ë´ãÊúüÂæÖÔºÅüöÄ`, 'info');
                        }
                    });
                });
            }
        });

        // Fortune prediction function
        async function handleFortunePredict() {
            const imageFile = document.getElementById('imageUpload').files[0];
            
            if (!imageFile) {
                showNotification('Ë´ãÂÖà‰∏äÂÇ≥‰∏ÄÂºµÁÖßÁâáÊâçËÉΩÈÄ≤Ë°åÈÅãÂã¢È†êÊ∏¨ÔºÅüì∏', 'warning');
                return;
            }
            
            // Show loading state
            loadingIndicator.style.display = 'block';
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'üîÆ ÈÅãÂã¢È†êÊ∏¨‰∏≠...';
            submitBtn.classList.add('pulse-loading');
            
            // Clear previous results
            aiResponseDiv.textContent = '';
            aiResponseContainer.style.display = 'none';
            hideError();
            
            // Start progress simulation
            simulateProgress();
            
            try {
                const formData = new FormData();
                formData.append('image', imageFile);
                formData.append('analysisType', 'fortune'); // Special flag for fortune prediction
                formData.append('style', 'mystical');
                formData.append('language', 'zh');
                formData.append('stylePrompt', 'Ë´ãÊ†πÊìöÈù¢Áõ∏ÁâπÂæµÈÄ≤Ë°åÈÅãÂã¢È†êÊ∏¨ÔºåÂåÖÊã¨ËøëÊúüÈÅãÂã¢„ÄÅË≤°ÈÅã„ÄÅÊÑüÊÉÖÈÅã„ÄÅ‰∫ãÊ•≠ÈÅãÂíåÂÅ•Â∫∑ÈÅãÂã¢ÁöÑÂàÜÊûê');
                
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: '‰º∫ÊúçÂô®ÈåØË™§ÔºåÁÑ°Ê≥ïËß£ÊûêÂõûÊáâ„ÄÇ' }));
                    throw new Error(errorData.error || 'ÈÅãÂã¢È†êÊ∏¨Â§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶');
                }
                
                const result = await response.json();
                
                // Display fortune prediction results
                const fortuneComment = result.aiComment || '‰ªäÊó•ÈÅãÂã¢Á•ûÁßòËé´Ê∏¨...';
                currentComment = `üîÆ ÈÅãÂã¢È†êÊ∏¨Ôºö${fortuneComment}`; // Store for sharing
                
                // Show results with special fortune styling
                aiResponseContainer.classList.add('fortune-result');
                aiResponseContainer.style.display = 'block';
                const responseHeader = aiResponseContainer.querySelector('h2');
                responseHeader.textContent = 'üîÆ AI ÈÅãÂã¢È†êÊ∏¨ÂàÜÊûêÔºö';
                
                typewriterEffect(aiResponseDiv, fortuneComment);
                
                // Show action buttons
                document.getElementById('retryBtn').style.display = 'inline-block';
                document.getElementById('tryAgainBtn').style.display = 'inline-block';
                
                // Show rating and share sections
                setTimeout(() => {
                    document.getElementById('ratingSection').style.display = 'block';
                    document.getElementById('shareSection').style.display = 'block';
                }, 2000);
                
                // Add to history
                if (historyManager) {
                    historyManager.addAnalysis({
                        type: 'fortune',
                        image: imageFile,
                        result: fortuneComment,
                        timestamp: new Date().toISOString()
                    });
                }
                
                showNotification('üîÆ ÈÅãÂã¢È†êÊ∏¨ÂÆåÊàêÔºÅ', 'success');
                
            } catch (error) {
                console.error('Fortune prediction error:', error);
                showError(`ÈÅãÂã¢È†êÊ∏¨Â§±ÊïóÔºö${error.message}`);
            } finally {
                // Reset loading state
                loadingIndicator.style.display = 'none';
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
                submitBtn.classList.remove('pulse-loading');
                updateProgress(0);
            }
        }
        
        // Detailed report function
        async function handleDetailedReport() {
            const imageFile = document.getElementById('imageUpload').files[0];
            
            if (!imageFile) {
                showNotification('Ë´ãÂÖà‰∏äÂÇ≥‰∏ÄÂºµÁÖßÁâáÊâçËÉΩÁîüÊàêË©≥Á¥∞Â†±ÂëäÔºÅüìä', 'warning');
                return;
            }
            
            // Show loading state
            loadingIndicator.style.display = 'block';
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'üìä ÁîüÊàêË©≥Á¥∞Â†±Âëä‰∏≠...';
            submitBtn.classList.add('pulse-loading');
            
            // Clear previous results
            aiResponseDiv.textContent = '';
            aiResponseContainer.style.display = 'none';
            hideError();
            
            // Start progress simulation
            simulateProgress();
            
            try {
                const formData = new FormData();
                formData.append('image', imageFile);
                formData.append('analysisType', 'detailed'); // Special flag for detailed report
                formData.append('style', 'professional');
                formData.append('language', 'zh');
                formData.append('stylePrompt', 'Ë´ãÊèê‰æõË©≥Á¥∞ÁöÑÈù¢Áõ∏ÂàÜÊûêÂ†±ÂëäÔºåÂåÖÊã¨‰∫îÂÆòÁâπÂæµÂàÜÊûê„ÄÅÊÄßÊ†ºÁâπË≥™„ÄÅÂ§©Ë≥¶ÊâçËÉΩ„ÄÅ‰∫∫ÈöõÈóú‰øÇ„ÄÅ‰∫ãÊ•≠ÁôºÂ±ïÂª∫Ë≠∞ÂíåÊ≥®ÊÑè‰∫ãÈ†ÖÁ≠âÂÖ®Èù¢ÂàÜÊûê');
                
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: '‰º∫ÊúçÂô®ÈåØË™§ÔºåÁÑ°Ê≥ïËß£ÊûêÂõûÊáâ„ÄÇ' }));
                    throw new Error(errorData.error || 'Ë©≥Á¥∞Â†±ÂëäÁîüÊàêÂ§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶');
                }
                
                const result = await response.json();
                
                // Display detailed report results
                const reportComment = result.aiComment || 'Ë©≥Á¥∞ÂàÜÊûêÂ†±ÂëäÁîüÊàê‰∏≠...';
                currentComment = `üìä Ë©≥Á¥∞Â†±ÂëäÔºö${reportComment}`; // Store for sharing
                
                // Show results with special report styling
                aiResponseContainer.classList.add('detailed-report');
                aiResponseContainer.style.display = 'block';
                const responseHeader = aiResponseContainer.querySelector('h2');
                responseHeader.textContent = 'üìä AI Ë©≥Á¥∞Èù¢Áõ∏ÂàÜÊûêÂ†±ÂëäÔºö';
                
                typewriterEffect(aiResponseDiv, reportComment);
                
                // Show action buttons
                document.getElementById('retryBtn').style.display = 'inline-block';
                document.getElementById('tryAgainBtn').style.display = 'inline-block';
                
                // Show rating and share sections
                setTimeout(() => {
                    document.getElementById('ratingSection').style.display = 'block';
                    document.getElementById('shareSection').style.display = 'block';
                }, 2000);
                
                // Add to history
                if (historyManager) {
                    historyManager.addAnalysis({
                        type: 'detailed',
                        image: imageFile,
                        result: reportComment,
                        timestamp: new Date().toISOString()
                    });
                }
                
                showNotification('üìä Ë©≥Á¥∞Â†±ÂëäÁîüÊàêÂÆåÊàêÔºÅ', 'success');
                
            } catch (error) {
                console.error('Detailed report error:', error);
                showError(`Ë©≥Á¥∞Â†±ÂëäÁîüÊàêÂ§±ÊïóÔºö${error.message}`);
            } finally {
                // Reset loading state
                loadingIndicator.style.display = 'none';
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
                submitBtn.classList.remove('pulse-loading');
                updateProgress(0);
            }
        }
        
        // Emotion recognition function
        async function handleEmotionRecognition() {
            const imageFile = document.getElementById('imageUpload').files[0];
            
            if (!imageFile) {
                showNotification('Ë´ãÂÖà‰∏äÂÇ≥‰∏ÄÂºµÁÖßÁâáÊâçËÉΩÈÄ≤Ë°åÊÉÖÁ∑íË≠òÂà•ÔºÅüé≠', 'warning');
                return;
            }
            
            // Show loading state
            loadingIndicator.style.display = 'block';
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'üé≠ ÊÉÖÁ∑íË≠òÂà•‰∏≠...';
            submitBtn.classList.add('pulse-loading');
            
            // Clear previous results
            aiResponseDiv.textContent = '';
            aiResponseContainer.style.display = 'none';
            hideError();
            
            // Start progress simulation
            simulateProgress();
            
            try {
                const formData = new FormData();
                formData.append('image', imageFile);
                formData.append('analysisType', 'emotion'); // Special flag for emotion recognition
                formData.append('style', 'empathetic');
                formData.append('language', 'zh');
                formData.append('stylePrompt', 'Ë´ãÊ†πÊìöÈù¢ÈÉ®Ë°®ÊÉÖÂíåÂæÆË°®ÊÉÖÈÄ≤Ë°åÊÉÖÁ∑íË≠òÂà•ÂàÜÊûêÔºåÂåÖÊã¨Áï∂ÂâçÊÉÖÁ∑íÁãÄÊÖã„ÄÅÊÉÖÁ∑íÂº∑Â∫¶„ÄÅÊΩõÂú®ÂøÉÁêÜÁãÄÊÖãÂíåÊÉÖÁ∑íË™øÁØÄÂª∫Ë≠∞');
                
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: '‰º∫ÊúçÂô®ÈåØË™§ÔºåÁÑ°Ê≥ïËß£ÊûêÂõûÊáâ„ÄÇ' }));
                    throw new Error(errorData.error || 'ÊÉÖÁ∑íË≠òÂà•Â§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶');
                }
                
                const result = await response.json();
                
                // Display emotion recognition results
                const emotionComment = result.aiComment || 'ÊÉÖÁ∑íË≠òÂà•ÂàÜÊûê‰∏≠...';
                currentComment = `üé≠ ÊÉÖÁ∑íË≠òÂà•Ôºö${emotionComment}`; // Store for sharing
                
                // Show results with special emotion styling
                aiResponseContainer.classList.add('emotion-analysis');
                aiResponseContainer.style.display = 'block';
                const responseHeader = aiResponseContainer.querySelector('h2');
                responseHeader.textContent = 'üé≠ AI ÊÉÖÁ∑íË≠òÂà•ÂàÜÊûêÔºö';
                
                typewriterEffect(aiResponseDiv, emotionComment);
                
                // Show action buttons
                document.getElementById('retryBtn').style.display = 'inline-block';
                document.getElementById('tryAgainBtn').style.display = 'inline-block';
                
                // Show rating and share sections
                setTimeout(() => {
                    document.getElementById('ratingSection').style.display = 'block';
                    document.getElementById('shareSection').style.display = 'block';
                }, 2000);
                
                // Add to history
                if (historyManager) {
                    historyManager.addAnalysis({
                        type: 'emotion',
                        image: imageFile,
                        result: emotionComment,
                        timestamp: new Date().toISOString()
                    });
                }
                
                showNotification('üé≠ ÊÉÖÁ∑íË≠òÂà•ÂÆåÊàêÔºÅ', 'success');
                
            } catch (error) {
                console.error('Emotion recognition error:', error);
                showError(`ÊÉÖÁ∑íË≠òÂà•Â§±ÊïóÔºö${error.message}`);
            } finally {
                // Reset loading state
                loadingIndicator.style.display = 'none';
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
                submitBtn.classList.remove('pulse-loading');
                updateProgress(0);
            }
        }
        
        // Notification function for coming soon features
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            
            // Add notification styles
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
                z-index: 10000;
                font-size: 0.9em;
                max-width: 300px;
                animation: slideInRight 0.3s ease-out;
            `;
            
            document.body.appendChild(notification);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease-in';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // Reset analysis function - clears everything and goes back to initial state
        function resetAnalysis() {
            // Clear file input
            document.getElementById('imageUpload').value = '';
            
            // Reset file name display
            document.getElementById('fileName').textContent = 'Â∞öÊú™ÈÅ∏Êìá‰ªª‰ΩïÊ™îÊ°à';
            
            // Clear image preview
            imagePreviewDiv.innerHTML = '';
            imagePreviewDiv.style.display = 'none';
            
            // Hide AI response container
            aiResponseContainer.style.display = 'none';
            aiResponseContainer.classList.remove('fortune-result'); // Remove fortune styling
            
            // Clear AI response
            aiResponseDiv.textContent = '';
            aiResponseDiv.classList.remove('loading');
            
            // Hide rating and share sections
            document.getElementById('ratingSection').style.display = 'none';
            document.getElementById('shareSection').style.display = 'none';
            
            // Hide action buttons
            document.getElementById('tryAgainBtn').style.display = 'none';
            
            // Reset submit button
            submitBtn.disabled = true;
            submitBtn.textContent = 'ÈñãÂßãÈù¢Áõ∏ÂàÜÊûêÔºÅ';
            submitBtn.classList.remove('pulse-loading');
            
            // Hide loading indicator
            loadingIndicator.style.display = 'none';
            
            // Hide error display
            hideError();
            
            // Reset progress
            updateProgress(0);
            
            // Reset rating
            currentRating = 0;
            updateStars(0);
            updateRatingText(0);
            
            // Reset theme to default
            document.body.className = document.body.className.replace(/theme-\w+/g, '');
            
            // Show notification
            showNotification('Â∑≤ÈáçÁΩÆÔºåË´ãÈáçÊñ∞ÈÅ∏ÊìáÂúñÁâá', 'info');
        }

        // Try again function - keeps the same image but re-runs analysis
        function tryAgain() {
            const imageFile = document.getElementById('imageUpload').files[0];
            
            if (!imageFile) {
                showNotification('Ë´ãÂÖàÈÅ∏Êìá‰∏ÄÂºµÂúñÁâá', 'error');
                return;
            }
            
            // Clear previous results but keep the image
            aiResponseDiv.textContent = '';
            aiResponseDiv.classList.remove('loading');
            aiResponseContainer.style.display = 'none';
            
            // Hide rating and share sections
            document.getElementById('ratingSection').style.display = 'none';
            document.getElementById('shareSection').style.display = 'none';
            
            // Hide action buttons
            document.getElementById('tryAgainBtn').style.display = 'none';
            
            // Reset rating
            currentRating = 0;
            updateStars(0);
            updateRatingText(0);
            
            // Hide error display
            hideError();
            
            // Create form data and submit again
            const formData = new FormData();
            formData.append('image', imageFile);
            
            // Get current style and language settings
            const styleSelect = document.getElementById('styleSelect');
            const languageSelect = document.getElementById('languageSelect');
            
            if (styleSelect && styleSelect.value) {
                formData.append('style', styleSelect.value);
            }
            if (languageSelect && languageSelect.value) {
                formData.append('language', languageSelect.value);
            }
            
            // Add style prompt if available
            const stylePrompts = {
                'professional': 'Ë´ã‰ª•Â∞àÊ•≠ÂøÉÁêÜÂ≠∏ËßíÂ∫¶ÂàÜÊûê',
                'cute': 'Ë´ãÁî®ÂèØÊÑõÊ¥ªÊΩëÁöÑË™ûÊ∞£ÂàÜÊûê',
                'mystical': 'Ë´ã‰ª•Á•ûÁßòÁéÑÂ≠∏ÁöÑËßíÂ∫¶ÂàÜÊûê',
                'scientific': 'Ë´ã‰ª•ÁßëÂ≠∏ÂÆ¢ËßÄÁöÑÊñπÂºèÂàÜÊûê',
                'friendly': 'Ë´ãÁî®Ë¶™ÂàáÂèãÂñÑÁöÑË™ûÊ∞£ÂàÜÊûê'
            };
            
            const currentStyle = styleSelect ? styleSelect.value : 'professional';
            const stylePrompt = stylePrompts[currentStyle] || stylePrompts['professional'];
            formData.append('stylePrompt', stylePrompt);
            
            // Show notification and submit
            showNotification('ÈáçÊñ∞ÂàÜÊûê‰∏≠...', 'info');
            submitFormData(formData);
        }
    </script>
</body>
</html>

<style>
    #aiResponseContainer {
        margin-top: 30px;
        width: 100%;
        text-align: left;
        display: block;
    }

    #aiResponseContainer h2 {
        color: #e83e8c;
        font-size: 1.5em;
        margin-bottom: 15px;
        text-align: center;
    }

    .image-preview-container, #imagePreview {
        margin-top: 15px;
        margin-bottom: 25px;
        display: block;
        text-align: center;
        min-height: 150px;
        background-color: #fff9fb;
        border-radius: 12px;
        padding: 15px;
        border: 2px dashed #ffdae5;
        width: 100%;
        box-sizing: border-box;
        overflow: hidden;
    }

    #imagePreview img {
        max-width: 100%;
        max-height: 400px;
        width: auto;
        height: auto;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        object-fit: contain;
        display: block;
    }

    @keyframes imagePreviewFadeIn {
        0% {
            opacity: 0;
            transform: scale(0.8) translateY(20px);
        }
        100% {
            opacity: 1;
            transform: scale(1) translateY(0);
        }
    }

    #aiResponse {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border: 2px solid #e91e63;
        border-radius: 15px;
        padding: 20px;
        margin-top: 20px;
        font-size: 1.1em;
        line-height: 1.6;
        color: #333;
        min-height: 80px;
        box-shadow: 0 4px 15px rgba(233, 30, 99, 0.1);
        word-wrap: break-word;
        overflow-wrap: break-word;
    }

    #aiResponse strong {
        color: #e91e63;
        font-weight: 700;
    }

    #aiResponse em {
        color: #6c757d;
        font-style: italic;
    }

    #aiResponse ul {
        margin: 10px 0;
        padding-left: 20px;
    }

    #aiResponse li {
        margin: 5px 0;
        color: #495057;
    }

    /* Mobile responsive fixes */
    @media (max-width: 768px) {
        .image-preview-container, #imagePreview {
            margin-top: 10px;
            margin-bottom: 20px;
            min-height: 120px;
            padding: 10px;
        }
        
        #imagePreview img {
            max-height: 250px;
        }
        
        #aiResponse {
            font-size: 1em;
            padding: 15px;
            line-height: 1.5;
        }
        
        #aiResponseContainer h2 {
            font-size: 1.3em;
            margin-bottom: 10px;
        }
    }

    @media (max-width: 480px) {
        .image-preview-container, #imagePreview {
            min-height: 100px;
            padding: 8px;
        }
        
        #imagePreview img {
            max-height: 200px;
        }
        
        #aiResponse {
            font-size: 0.95em;
            padding: 12px;
        }
        
        #aiResponseContainer h2 {
            font-size: 1.2em;
        }
    }
</style>